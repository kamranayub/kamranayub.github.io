<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=Edge" />

  <title>Kamranicus - Working with Computed Columns in EF 4.3</title>
  <meta name="description" content="Kamran Ayub" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="author" content="Kamran Ayub">

  <link href="http://feeds.feedburner.com/Kamranicus" rel="alternate" title="Kamranicus (RSS)" type="application/atom+xml">
  <link rel="shortcut icon" href="/favicon.png" type="image/png">
  <link rel="icon" href="/favicon.png" type="image/png">

  <link href="/assets/ui/semantic.min.css" rel="stylesheet" />
  <link href="/assets/css/highlight.css" rel="stylesheet">

  <meta name="application-name" content="Kamranicus" />
  <meta name="msapplication-tooltip" content="Kamranicus" />
  <meta name="msapplication-starturl" content="/" />

  <meta property="og:title" content="Kamranicus - Working with Computed Columns in EF 4.3" /> 
  <meta property="og:type" content="website" />
  <meta property="og:url" content="https://kamranicus.com/posts/2012-03-17-working-with-computed-columns-in-ef-43" />
  <meta property="og:site_name" content="Kamranicus" />

  <!-- TODO: More social graph meta tags -->
  <script type="application/ld+json">
  {
      "@context": "http://schema.org",
      "@type": "WebSite",
      "name": "Kamranicus",
      "url": "https://kamranicus.com/",
      "sameAs": [
        "http://www.twitter.com/kamranayub"
      ]
  }
  </script>


  <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
  <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
  <!--[if lt IE 9]>
    <script src="/assets/js/html5shiv.js"></script>
    <script src="/assets/js/respond.min.js"></script>
  <![endif]-->
  <script src="/assets/js/picturefill.min.js" async></script>


  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-1203259-13']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>
  

  


</head>

<body>

  <!-- Navigation -->
  <div class="ui container">
    <nav class="ui huge text site menu">
      
      <a class="header item" href="/">Kamranicus</a>
      
      <div class="ui right item">
              <div class="item">
        <a href="/about">About</a>
      </div>
      <div class="item">
        <a href="/posts">Archive</a>
      </div>
      <div class="item">
        <a href="/guides">Guides</a>
      </div>
      <div class="item">
        <a href="/projects">Projects</a>
      </div>
      <div class="item">
        <a href="/speaking">Speaking</a>
      </div>
      <div class="item">
        <a href="/travel">Travel</a>
      </div>

      </div>
    </nav>
  </div>
  <!-- Page Header -->

  <header class="ui vertical masthead segment " id="intro-header">
    <div class="ui container">

    
<div class="ui basic vertical segment">
    <h1 class="ui  huge header">
      Working with Computed Columns in EF 4.3
    </h1>
                
    <div class="ui  sub header">        
Published on Sunday, March 18, 2012<br>    </div>
        <div class="ui basic vertical spaced segment">
                    <a role="button" href="/tags/net" class="ui small compact button">.NET</a>
                    <a role="button" href="/tags/c%23" class="ui small compact button">C#</a>
                    <a role="button" href="/tags/entity-framework" class="ui small compact button">Entity Framework</a>
        </div>     
</div>
    </div>
  </header>

  <!-- Main Content -->
  <div class="ui stackable grid container">
    <div class="content column">
      

<div class="ui huge basic post content segment">
  <p>There's not a ton of information out there on how to handle computed columns in EF. It turns out it is pretty straightforward if you know what to do.</p>
<h2 id="telling-ef-about-your-computed-column">Telling EF about your computed column</h2>
<p>First, if all you want to do is manually create a function and use it in a column, you only need to decorate your model property with <code>[DatabaseGenerated(DatabaseGeneratedOption.Computed)]</code> as seen here:</p>
<pre><code class="language-c#">public class Person {

    public string FirstName { get; set; }
    public string LastName { get; set; }

    [DatabaseGenerated(DatabaseGeneratedOption.Computed)]
    public string FullName { get; set; }
}
</code></pre>
<p>You should know that <strong>if possible, try to keep &quot;computed&quot; values in your application.</strong> This is my opinion from an ease of use POV, not a design POV. I say it because unless you really <em>need</em> a computed column, you could just as easily create a read-only property that EF ignores.</p>
<p>However, in some cases, a computed column is a viable option such as when you need to sort (on the database-side) against a computed value. That was my own reason for using a computed.</p>
<h2 id="manually-adding-the-function-and-column">Manually adding the function and column</h2>
<p>We've told EF to ignore our property and treat it as a computed column. Now how do we actually <em>create</em> the column? Well, what I did previous to EF Migrations was to just do it all manually through SQL Management Studio. This is entirely OK to do, you just need to make sure you save the script somewhere or remember to do it anytime you create a new database for your application.</p>
<p>You can now go into SSMS and delete the column EF generated (or add it if it's new). Make sure you create your function first:</p>
<pre><code class="language-sql">CREATE FUNCTION [dbo].[GetFullName] 
(
    -- Add the parameters for the function here
    &#64;FirstName varchar(50),
    &#64;LastName varchar(50)
)
RETURNS varchar(255)
AS
BEGIN
    DECLARE &#64;FullName varchar(255);

    SELECT &#64;FullName = &#64;FirstName + ' ' + &#64;LastName;

    RETURN &#64;FullName;
END
</code></pre>
<p>That approach worked fine for me, since I use Schema Compare (or used to!) to migrate my database between environments.</p>
<h2 id="using-ef-migrations">Using EF Migrations</h2>
<p>Now that EF 4.3 has been released, we can all enjoy the benefit of <a href="http://blogs.msdn.com/b/adonet/archive/2012/02/09/ef-4-3-automatic-migrations-walkthrough.aspx">Database Migrations</a>. What I like about this approach is that it's very deliberate and discoverable. I could clone my repository onto a new PC and run the <code>Update-Database</code> command to do <em>everything</em>, plus now we can migrate backwards if needed. It's excellent!</p>
<p>I am using automatic migrations for <a href="http://keeptrackofmygames.com">KTOMG</a>, so what I had to do first was manually create a new migration in the Package Manager console:</p>
<pre><code>$&gt; Add-Migration CustomFunction
</code></pre>
<p>This will scaffold a new, empty migration:</p>
<pre><code class="language-c#">public partial class CustomFunction : DbMigration
{
    public override void Up()
    {
    }
    
    public override void Down()
    {
    }
}
</code></pre>
<p>Now we can be really cool cats. In this migration, all we have to do is execute our <code>CREATE FUNCTION</code> SQL statement in the <code>Up</code> method, along with dropping and re-adding the column:</p>
<pre><code class="language-c#">public override void Up()
{
    // Create function
    Sql(&#64;&quot;
CREATE FUNCTION [dbo].[GetFullName] 
(
-- Add the parameters for the function here
&#64;FirstName varchar(50),
&#64;LastName varchar(50)
)
RETURNS varchar(255)
AS
BEGIN
DECLARE &#64;FullName varchar(255);

SELECT &#64;FullName = &#64;FirstName + ' ' + &#64;LastName;

RETURN &#64;FullName;
END
&quot;, true);

    // Add the computed column
    DropColumn(&quot;Person&quot;, &quot;FullName&quot;);
    Sql(&#64;&quot;
ALTER TABLE [dbo].[Person]
ADD [FullName] AS ([dbo].[GetFullName]([FirstName],[LastName]));
&quot;);
}
</code></pre>
<p>Take note of the <code>true</code> parameter at the end of the <code>Sql()</code> call. This explicitly tells EF <em>not</em> to include the statement in the migration transaction. If you don't do this, SQL Server will complain that the CREATE FUNCTION statement must be the only one in the batch.</p>
<p>Now let's scaffold our tear down step. We should drop the column first, drop the function, and then finally re-add the basic column back.</p>
<pre><code class="language-c#">public override void Down()
{
    DropColumn(&quot;Person&quot;, &quot;FullName&quot;);
    Sql(&quot;DROP FUNCTION [dbo].[GetFullName]&quot;);
    AddColumn(&quot;Person&quot;, &quot;FullName&quot;, c =&gt; c.String(nullable: true, maxLength: 255));    
}
</code></pre>
<p>I would take care to make sure the column is re-created using the original schema EF created.</p>
<p>Now we can tell EF to migrate to the latest version:</p>
<pre><code>$&gt; Update-Database -Verbose (or -Script, to preview)
</code></pre>
<p>Voila, you should now have a brand spankin' new computed column.</p>

</div>

<div class="ui horizontal divider">
  About Kamran
</div>

<div class="ui items">
  <div class="item">
    <div class="ui small circular image">
      <img src="/assets/images/me.jpg" title="Kamran Ayub">
    </div>

    <div class="content">
      <div class="description">
        Hi, I&#x27;m a professional full-stack developer who also loves to write, speak at conferences, work on side projects, contribute to open source, make games, and play them.
      </div>
      <div class="extra">
        <a class="ui circular icon button" href="https://twitter.com/kamranayub" title="Twitter">
  <i class="twitter icon"></i>
</a>
<a class="ui circular icon button" href="https://github.com/kamranayub" title="GitHub">
  <i class="github icon"></i>
</a>
<a class="ui circular icon button" href="https://instagram.com/subkamran" title="Instagram">
  <i class="instagram icon"></i>
</a>
<a class="ui circular icon button" href="https://www.youtube.com/channel/UCq6oaAI3ZH2rGlmC9VqJm1g" title="YouTube">
  <i class="youtube icon"></i>
</a>
<a class="ui circular icon button" href="https://www.linkedin.com/in/subkamran" title="LinkedIn">
  <i class="linkedin icon"></i>
</a>
      </div>
    </div>
  </div>
</div>

<div id="disqus_thread"></div>

<script type="text/javascript">
    var disqus_shortname = 'kamranicus';
    var disqus_identifier = '35';
    var disqus_title = 'Working with Computed Columns in EF 4.3';
    var disqus_url = 'https://kamranicus.com/posts/2012-03-17-working-with-computed-columns-in-ef-43';

    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
    
    (function () {
        var s = document.createElement('script'); s.async = true;
        s.type = 'text/javascript';
        s.src = '//' + disqus_shortname + '.disqus.com/count.js';
        (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
    }());
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>

      <!-- Disqus -->
<div id="disqus_thread"></div>

<script type="text/javascript">
    var disqus_shortname = 'kamranicus';
    var disqus_identifier = '35';
    var disqus_title = 'Working with Computed Columns in EF 4.3';
    var disqus_url = 'https://kamranicus.com/posts/2012-03-17-working-with-computed-columns-in-ef-43';

    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
    
    (function () {
        var s = document.createElement('script'); s.async = true;
        s.type = 'text/javascript';
        s.src = '//' + disqus_shortname + '.disqus.com/count.js';
        (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
    }());
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>    </div>
  </div>

  <div class="ui divider"></div>
  
  <!-- Footer -->
  <footer>   
    <div class="ui center aligned container">
  <p class="ui grey sub header">Copyright Â© Kamran Ayub 2017</p>
  
  <div class="ui basic vertical segment">
    <a class="ui circular icon button" href="https://twitter.com/kamranayub" title="Twitter">
  <i class="twitter icon"></i>
</a>
<a class="ui circular icon button" href="https://github.com/kamranayub" title="GitHub">
  <i class="github icon"></i>
</a>
<a class="ui circular icon button" href="https://instagram.com/subkamran" title="Instagram">
  <i class="instagram icon"></i>
</a>
<a class="ui circular icon button" href="https://www.youtube.com/channel/UCq6oaAI3ZH2rGlmC9VqJm1g" title="YouTube">
  <i class="youtube icon"></i>
</a>
<a class="ui circular icon button" href="https://www.linkedin.com/in/subkamran" title="LinkedIn">
  <i class="linkedin icon"></i>
</a>
  </div>

  <p class="ui basic vertical segment">      
    <a href="http://feeds.feedburner.com/Kamranicus" class="ui right labeled icon button">
      Subscribe via RSS or email
      <i class="right rss icon"></i>
    </a>
  </p>  
  <p class="ui tiny basic vertical segment">
    <a href="https://wyam.io">Statically generated by Wyam</a>
  </p>
</div>

  </footer>

  <script src="https://code.jquery.com/jquery-3.1.1.min.js" integrity="sha256-hVVnYaiADRTO2PzUGmuLJr8BLUSjGIZsDYGmIJLv2b8="
    crossorigin="anonymous"></script>
  <script src="/assets/ui/semantic.min.js"></script>
  <script src="/assets/js/highlight.pack.js"></script>

  

  <script>hljs.initHighlightingOnLoad();</script>
</body>
</html>