<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=Edge" />

  <title>Kamranicus | Kamran Ayub - Extending PowerShell Pester with Custom Assertions</title>
  <meta name="description" content="Kamran Ayub" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="author" content="Kamran Ayub">

  <link href="http://feeds.feedburner.com/Kamranicus" rel="alternate" title="Kamranicus (RSS)" type="application/atom+xml">
  <link rel="shortcut icon" href="/favicon.png" type="image/png">
  <link rel="icon" href="/favicon.png" type="image/png">

  <link href="/assets/ui/semantic.min.css" rel="stylesheet" />
  <link href="/assets/css/highlight.css" rel="stylesheet">

  <meta name="monetization" content="$ilp.uphold.com/GkRBn6N6hM9q" />
  
  <meta name="application-name" content="Kamranicus | Kamran Ayub" />
  <meta name="msapplication-tooltip" content="Kamranicus | Kamran Ayub" />
  <meta name="msapplication-starturl" content="/" />

  <meta property="og:title" content="Kamranicus | Kamran Ayub - Extending PowerShell Pester with Custom Assertions" /> 
  <meta property="og:type" content="website" />
  <meta property="og:url" content="https://kamranicus.com/posts/2016-08-16-posh-pester-extend-custom-assertions" />
  <meta property="og:site_name" content="Kamranicus" />
  <meta property="twitter:card" content="summary" />
  <meta property="twitter:creator" content="@kamranayub" />

  <!-- TODO: More social graph meta tags -->
  <script type="application/ld+json">
  {
      "@context": "http://schema.org",
      "@type": "WebSite",
      "name": "Kamranicus",
      "url": "https://kamranicus.com/",
      "sameAs": [
        "http://www.twitter.com/kamranayub"
      ]
  }
  </script>


  <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
  <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
  <!--[if lt IE 9]>
    <script src="/assets/js/html5shiv.js"></script>
    <script src="/assets/js/respond.min.js"></script>
  <![endif]-->
  <script src="/assets/js/picturefill.min.js" async></script>

  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-1203259-13']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>
  

  


</head>

<body>

  <!-- Navigation -->
  <div class="ui container">
    <nav class="ui huge text site menu">
      
      <a class="header item" href="/">Kamranicus | Kamran Ayub</a>
      
      <div class="ui right item">
              <div class="item">
        <a href="/about">Contact</a>
      </div>
      <div class="item">
        <a href="/events">Events</a>
      </div>
      <div class="item">
        <a href="/guides">Guides</a>
      </div>
      <div class="item">
        <a href="/projects">Projects</a>
      </div>
      <div class="item">
        <a href="/training">Training</a>
      </div>
      <div class="item">
        <a href="/travel">Travel</a>
      </div>

      </div>
    </nav>
  </div>
  <!-- Page Header -->

  <header class="ui vertical masthead segment  " id="intro-header">
    <div class="ui container">

    
<div class="ui basic vertical segment">
    <h1 class="ui  huge header">
      Extending PowerShell Pester with Custom Assertions
    </h1>
                
    <div class="ui  sub header">        
Published on Wednesday, August 17, 2016<br>    </div>
        <div class="ui basic vertical spaced segment">
                    <a role="button" href="/tags/OSS" class="ui small compact button">OSS</a>
                    <a role="button" href="/tags/PowerShell" class="ui small compact button">PowerShell</a>
                    <a role="button" href="/tags/Testing" class="ui small compact button">Testing</a>
        </div>     
</div>
    </div>
  </header>

  <!-- Main Content -->
  <div class="ui stackable grid container">
    <div class="content column">
      

<div class="ui huge basic post content segment">
  <p>After the initial release of <a href="http://kamranicus.com/blog/2016/08/12/posh-openweathermap-powershell-module/">my OpenWeatherMap PowerShell module</a> I decided it might be a good idea to write some tests. This was my first time using <a href="https://github.com/pester/Pester">Pester</a>, a BDD-style testing framework for PowerShell. Coming from <a href="http://jasmine.github.io/">Jasmine</a> Javascript unit testing, I felt right at home.</p>
<!-- More -->
<p>Now because my module deals a lot with dates, I wanted to use an assertion that simplified some of the logic of testing a date. For example, this is what it looks like validating a DateTime:</p>
<pre><code class="language-powershell">$Result.Time.Year   | Should Be 2015
$Result.Time.Month  | Should Be 8
$Result.Time.Day    | Should Be 15

$Result.Time.Hour   | Should Be 13
$Result.Time.Minute | Should Be 56
$Result.Time.Second | Should Be 32
</code></pre>
<p>The other way would be to compare formatted date strings:</p>
<pre><code class="language-powershell">$Result.Time.ToString(&quot;MM/dd/yyyy HH:mm:ss&quot;) | Should Be &quot;08/15/2015 13:56:32&quot;
</code></pre>
<p>Which is fine. However, using it as a learning opportunity, I wanted to write my own assertion for Pester, <code>BeDate</code> so I could do:</p>
<pre><code class="language-powershell">$Result.Time | Should BeDate &quot;08/15/2015 13:56:32&quot;
</code></pre>
<p>In C# using NUnit or MSTest, writing custom assertions is pretty straightforward. However, Pester essentially uses a convention where it loads up commands in its module starting with <code>Pester</code> and also having a couple failure message handlers.</p>
<p>So, for example, our <code>BeDate</code> assertion is defined as:</p>
<pre><code class="language-powershell">Function PesterBeDate($Value, $Expected) {
    $Expected = [System.DateTime]::Parse($Expected)

    $Value.Year   | Should Be $Expected.Year
    $Value.Month  | Should Be $Expected.Month
    $Value.Day    | Should Be $Expected.Day

    $Value.Hour   | Should Be $Expected.Hour
    $Value.Minute | Should Be $Expected.Minute
    $Value.Second | Should Be $Expected.Second
}

Function PesterBeDateFailureMessage($Value, $Expected) {
    if (-not (($expected -is [string]) -and ($value -is [System.DateTime])))
    {
        return &quot;Expected: {$expected}`nBut was:  {$value}&quot;
    }
    
    return &quot;Expected: $Expected\nBut was: $($Value.ToString('MM/dd/YYYY h:mm:ss'))&quot;
}

Function NotPesterBeDateFailureMessage($Value, $Expected) {
    return PesterBeDateFailureMessage -Value $Value -Expected $Expected
}
</code></pre>
<p>Now, I don't actually think my <code>PesterBeDateFailureMessage</code> cmdlet ever runs because I'm using the basic <code>Be</code> assertion but whatever--this is the convention.</p>
<p>So, how we do we get Pester to see these functions? Well, like I said, it searches for the assertions <strong>in the scope of the module</strong>. That means if I define these in my own file, it won't see them.</p>
<h2 id="defining-functions-inside-a-modules-scope">Defining functions inside a module's scope</h2>
<p>We can use a weird PowerShell &quot;hack&quot; to actually declare these functions <em>inside the scope of the Pester module</em> if we want.</p>
<pre><code class="language-powershell">$pesterModule = Import-Module Pester -PassThru

. $pesterModule {
    function PesterBeDate { }
    # etc
}
</code></pre>
<p>This is what Dave Wyatt suggested <a href="https://github.com/pester/Pester/issues/590#issuecomment-239977094">when I asked about it</a>. Cool, we <strong>could</strong> do that but I would prefer if we could keep my custom assertions separated from my tests since I'd have to include this in my <strong>.Tests.ps1</strong> files.</p>
<h2 id="using-local-modules-and-extending-pester">Using local modules and extending Pester</h2>
<p>The  implication the previous solution has is that the caller (user) has Pester installed globally. Over the years, as a programming community we decided that's a sub-optimal outlook on life hence we have package managers like Nuget and NPM. To my knowledge, there's not yet a <code>package.json</code> equivalent to a PowerShell &quot;project&quot; besides the Module Manifest (psd1). Ideally, I would be able to type <code>Install-Module</code> in the current directory, PowerShellGet would identify the dependencies (perhaps from psd1 manifest?), and download them. Alas, it doesn't so we can do it ourselves.</p>
<p>To achieve maximum contributability (is that a word?) I decided to roll my own little build script that would bring down the Pester module locally to the project and then extend Pester's assertions by manually copying in my own code.</p>
<p>This only takes a few lines of Powershell:</p>
<pre><code class="language-powershell">$PesterVersion = '3.4.2'

# Save-module locally
Save-Module -Name Pester -Path '.modules\' -RequiredVersion $PesterVersion

# Copy custom assertions
Copy-Item -Path '.\Assertions\*.ps1' -Destination &quot;.\.modules\Pester\$PesterVersion\Functions\Assertions&quot;

# Import local Pester module so we can extend built-in assertions
Import-Module &quot;.\.modules\Pester\$PesterVersion\Pester.psd1&quot;

# Run tests
Invoke-Pester -Script &quot;.\OpenWeatherMap.Tests.ps1&quot;
</code></pre>
<p>So this is fairly straightforward:</p>
<ol>
<li>Use <code>Save-Module</code> cmdlet to unzip and copy the Pester module locally to a <strong>.modules</strong> folder that we'll exclude from source control</li>
<li>Copy my <code>*.ps1</code> assertion files under *<em>Assertions*</em> to the local Pester assertions directory</li>
<li>Import the local Pester module explicitly (this will load our new assertions)</li>
<li>Invoke Pester on our test script (if you don't qualify it, it will run all the tests in the Pester module also!)</li>
</ol>
<p>Now we achieve both desired effects:</p>
<ol>
<li>Our repository is now self-contained and can be contributed to without any global dependencies (besides PowerShell 5)</li>
<li>We can keep our custom assertions separated</li>
</ol>
<p>If you want to see the final product, <a href="https://github.com/kamranayub/posh-openweathermap">give my OpenWeatherMap module a gander</a>!</p>

</div>

<h3 class="ui horizontal divider">
  Join the mailing list
</h3>

<div class="ui two column mobile tablet computer reversed divided grid">
  <div class="row">
    <div class="column">
      <p class="ui text tiny"><em>No spam and I usually send a newsletter once a week with writing you won't see on the blog.</em></p>
    </div>
    <div class="column">
      <div class="ui items" id="mc_embed_signup">
        <form action="https://kamranicus.us18.list-manage.com/subscribe/post?u=45a27b0b6fc6f929b90e35338&amp;id=89bb6697c0" method="post" id="mc-embedded-subscribe-form" name="mc-embedded-subscribe-form" class="validate" target="_blank" novalidate>
          <div class="item" id="mc_embed_signup_scroll">
            <div class="content">
              <div class="ui input">
                <input type="email" value="" name="EMAIL" placeholder="Your Email" class="required email" id="mce-EMAIL">
              </div>
              <div id="mce-responses" class="clear" style="margin-top: 1em;">
                <div class="response" id="mce-error-response" style="display:none"></div>
                <div class="response" id="mce-success-response" style="display:none"></div>
              </div>    <!-- real people should not fill this in and expect good things - do not remove this or risk form bot signups-->
              <div style="position: absolute; left: -5000px;" aria-hidden="true"><input type="text" name="b_45a27b0b6fc6f929b90e35338_89bb6697c0" tabindex="-1" value=""></div>
              <div class="clear"><input type="submit" value="Subscribe" name="subscribe" id="mc-embedded-subscribe" class="ui primary button"></div>
            </div>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>

<div class="ui horizontal divider">
  About Kamran
</div>

<div class="ui items">
  <div class="item">
    <div class="ui small circular image">
      <img src="/assets/images/me.jpg" title="Kamran Ayub">
    </div>

    <div class="content">
      <div class="description">
        <p>I&#x27;m a technologist, speaker, and Pluralsight author and I specialize in building full-stack solutions with a focus on modern web technology and cloud native architecture.</p>
        <p><a href="http://bit.ly/KamranOnPluralsight"><img src="/assets/images/pluralsight.png" alt="Kamran's Pluralsight courses" title="Check out my Pluralsight courses!" style="max-width:80%;margin:1em 0;"></a></p>
      </div>
      <div class="extra">
        <a class="ui circular icon button" href="https://twitter.com/kamranayub" title="Twitter">
  <i class="twitter icon"></i>
</a>
<a class="ui circular icon button" href="https://github.com/kamranayub" title="GitHub">
  <i class="github icon"></i>
</a>
<a class="ui circular icon button" href="https://instagram.com/subkamran" title="Instagram">
  <i class="instagram icon"></i>
</a>
<a class="ui circular icon button" href="https://www.youtube.com/channel/UCq6oaAI3ZH2rGlmC9VqJm1g " title="YouTube">
  <i class="youtube icon"></i>
</a>
<a class="ui circular icon button" href="https://twitch.tv/kamranicus " title="YouTube">
  <i class="twitch icon"></i>
</a>
<a class="ui circular icon button" href="https://www.linkedin.com/in/subkamran" title="LinkedIn">
  <i class="linkedin icon"></i>
</a>

      </div>
    </div>
  </div>
</div>

<!--<div id="disqus_thread"></div>-->




      <!-- Disqus -->
<!--<div id="disqus_thread"></div>-->

    </div>
  </div>

  <div class="ui divider"></div>
  
  <!-- Footer -->
  <footer>   
    <div class="ui center aligned container">
  <p class="ui grey sub header">Copyright © Kamran Ayub 2021</p>
  
  <div class="ui basic vertical segment">
    <a class="ui circular icon button" href="https://twitter.com/kamranayub" title="Twitter">
  <i class="twitter icon"></i>
</a>
<a class="ui circular icon button" href="https://github.com/kamranayub" title="GitHub">
  <i class="github icon"></i>
</a>
<a class="ui circular icon button" href="https://instagram.com/subkamran" title="Instagram">
  <i class="instagram icon"></i>
</a>
<a class="ui circular icon button" href="https://www.youtube.com/channel/UCq6oaAI3ZH2rGlmC9VqJm1g " title="YouTube">
  <i class="youtube icon"></i>
</a>
<a class="ui circular icon button" href="https://twitch.tv/kamranicus " title="YouTube">
  <i class="twitch icon"></i>
</a>
<a class="ui circular icon button" href="https://www.linkedin.com/in/subkamran" title="LinkedIn">
  <i class="linkedin icon"></i>
</a>

  </div>

  <p class="ui basic vertical segment">      
    <a href="http://feeds.feedburner.com/Kamranicus" class="ui right labeled icon button">
      Subscribe via RSS or email
      <i class="right rss icon"></i>
    </a>
  </p>  
  <p class="ui tiny basic vertical segment">
    <a href="https://wyam.io">Statically generated by Wyam</a>
  </p>
</div>

  </footer>

  <script src="https://code.jquery.com/jquery-3.1.1.min.js" integrity="sha256-hVVnYaiADRTO2PzUGmuLJr8BLUSjGIZsDYGmIJLv2b8="
    crossorigin="anonymous"></script>
  <script src="/assets/ui/semantic.min.js"></script>
  <script src="/assets/js/highlight.pack.js"></script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<script>
     (adsbygoogle = window.adsbygoogle || []).push({
          google_ad_client: "ca-pub-6930375300621668",
          enable_page_level_ads: true
     });
</script>

  <script>hljs.initHighlightingOnLoad();</script>
</body>
</html>
