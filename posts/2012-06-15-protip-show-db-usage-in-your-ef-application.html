<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=Edge" />

  <title>Kamranicus | Kamran Ayub - Protip: Show DB usage in your EF application</title>
  <meta name="description" content="Kamran Ayub" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="author" content="Kamran Ayub">

  <link href="http://feeds.feedburner.com/Kamranicus" rel="alternate" title="Kamranicus (RSS)" type="application/atom+xml">
  <link rel="shortcut icon" href="/favicon.png" type="image/png">
  <link rel="icon" href="/favicon.png" type="image/png">

  <link href="/assets/ui/semantic.min.css" rel="stylesheet" />
  <link href="/assets/css/highlight.css" rel="stylesheet">

  <meta name="monetization" content="$ilp.uphold.com/GkRBn6N6hM9q" />
  
  <meta name="application-name" content="Kamranicus | Kamran Ayub" />
  <meta name="msapplication-tooltip" content="Kamranicus | Kamran Ayub" />
  <meta name="msapplication-starturl" content="/" />

  <meta property="og:title" content="Kamranicus | Kamran Ayub - Protip: Show DB usage in your EF application" /> 
  <meta property="og:type" content="website" />
  <meta property="og:url" content="https://kamranicus.com/posts/2012-06-15-protip-show-db-usage-in-your-ef-application" />
  <meta property="og:site_name" content="Kamranicus" />
  <meta property="twitter:card" content="summary" />
  <meta property="twitter:creator" content="@kamranayub" />

  <!-- TODO: More social graph meta tags -->
  <script type="application/ld+json">
  {
      "@context": "http://schema.org",
      "@type": "WebSite",
      "name": "Kamranicus",
      "url": "https://kamranicus.com/",
      "sameAs": [
        "http://www.twitter.com/kamranayub"
      ]
  }
  </script>


  <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
  <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
  <!--[if lt IE 9]>
    <script src="/assets/js/html5shiv.js"></script>
    <script src="/assets/js/respond.min.js"></script>
  <![endif]-->
  <script src="/assets/js/picturefill.min.js" async></script>

  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-1203259-13']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>
  

  


</head>

<body>

  <!-- Navigation -->
  <div class="ui container">
    <nav class="ui huge text site menu">
      
      <a class="header item" href="/">Kamranicus | Kamran Ayub</a>
      
      <div class="ui right item">
              <div class="item">
        <a href="/about">Contact</a>
      </div>
      <div class="item">
        <a href="/events">Events</a>
      </div>
      <div class="item">
        <a href="/guides">Guides</a>
      </div>
      <div class="item">
        <a href="/projects">Projects</a>
      </div>
      <div class="item">
        <a href="/training">Training</a>
      </div>
      <div class="item">
        <a href="/travel">Travel</a>
      </div>

      </div>
    </nav>
  </div>
  <!-- Page Header -->

  <header class="ui vertical masthead segment  " id="intro-header">
    <div class="ui container">

    
<div class="ui basic vertical segment">
    <h1 class="ui  huge header">
      Protip: Show DB usage in your EF application
    </h1>
                
    <div class="ui  sub header">        
Published on Friday, June 15, 2012<br>    </div>
        <div class="ui basic vertical spaced segment">
                    <a role="button" href="/tags/ASPNET" class="ui small compact button">ASP.NET</a>
                    <a role="button" href="/tags/Entity-Framework" class="ui small compact button">Entity Framework</a>
                    <a role="button" href="/tags/MVC" class="ui small compact button">MVC</a>
        </div>     
</div>
    </div>
  </header>

  <!-- Main Content -->
  <div class="ui stackable grid container">
    <div class="content column">
      

<div class="ui huge basic post content segment">
  <p>My staging application is on <a href="http://appharbor.com">AppHarbor</a> so I gave it the shared Yocto SQL database which has a limit of 20MB. That's not much, so I wanted a way to display my current usage level in staging when I test the site in case I want to flush it out. It was fairly easy (with a gotcha)!</p>
<p><strong>MVC Layout</strong></p>
<pre><code class="language-html">&#64;if (AppSettings.RuntimeEnvironment != RuntimeEnvironment.P)
{
    &lt;p&gt;DB Usage: &#64;{ Html.RenderAction(&quot;DbUsage&quot;, &quot;Stats&quot;); }&lt;/p&gt;
}
</code></pre>
<p>I am rendering an action since I need to call out to my service layer.</p>
<p><strong>StatsController</strong></p>
<pre><code class="language-c#">[ChildActionOnly]
[GET(&quot;stats/dbusage&quot;)]
public ActionResult DbUsage()
{
    if (AppSettings.RuntimeEnvironment != RuntimeEnvironment.P)
    {
        return Content(SomeAbstraction.GetDatabaseUsageStat());
    }

    return new EmptyResult();
}
</code></pre>
<p>I am using <a href="https://github.com/mccalltd/AttributeRouting">AttributeRouting</a>, and if you use <code>RenderAction</code> you should know it requires a route to be made. I use <code>ChildActionOnly</code> to prevent browsing to the action. I also return an empty result if it's production (I only have 3 states).</p>
<p><strong>IRepository</strong></p>
<p>In my project, I have a application service layer that uses an injectable repository. I've found this makes integration testing pretty easy as my controllers are dumb as heck and leave all the logic up to the service layer where there's no need to mock any HTTP stuff.</p>
<p>I'll skip to the repository since that's where the actual code is.</p>
<pre><code class="language-c#">public string GetDbUsage()
{
    try
    {
        IEnumerable dt = _dbContext.Database.SqlQuery(typeof (DbUsage), &quot;sp_spaceused&quot;);

        if (dt == null)
            return &quot;Unknown&quot;;

        var usage = dt.OfType&lt;DbUsage&gt;().FirstOrDefault();

        return usage.database_size;
    } catch
    {
        return &quot;Unknown&quot;;
    }
}

private class DbUsage
{
    public string database_name { get; set; }
    public string database_size { get; set; }
}
</code></pre>
<p>This just executes the stored proc <code>sp_spaceused</code> and coerces it into the <code>DbUsage</code> type. The gotcha is that there's another column, &quot;unallocated space&quot; which <strong>for some ungodly, inconsistent reason</strong> has a space in it. I cannot figure out how to get it without resorting to an ADO.NET data reader. I'd appreciate any advice on how to grab that additional column as well.</p>
<p>If you want to log an error, you should, but I don't really care if I can't access the size... so I just ignore it. It's only for debugging.</p>
<p>And as for the result? Handy!</p>
<p><img src="/posts/images/53.png" class="img-fluid" alt="DB Usage" /></p>

</div>

<h3 class="ui horizontal divider">
  Don't miss any updates!
</h3>

<div class="ui two column mobile tablet computer reversed divided grid">
  <div class="row">
    <div class="column">
      <p class="ui text tiny"><em>No spam and I usually send a newsletter once a quarter with content you won't see on the blog.</em></p>
    </div>
    <div class="column">
      <div class="ui items" id="mc_embed_signup">
        <form action="https://kamranicus.us18.list-manage.com/subscribe/post?u=45a27b0b6fc6f929b90e35338&amp;id=89bb6697c0" method="post" id="mc-embedded-subscribe-form" name="mc-embedded-subscribe-form" class="validate" target="_blank" novalidate>
          <div class="item" id="mc_embed_signup_scroll">
            <div class="content">
              <div class="ui input">
                <input type="email" value="" name="EMAIL" placeholder="Your Email" class="required email" id="mce-EMAIL">
              </div>
              <div id="mce-responses" class="clear" style="margin-top: 1em;">
                <div class="response" id="mce-error-response" style="display:none"></div>
                <div class="response" id="mce-success-response" style="display:none"></div>
              </div>    <!-- real people should not fill this in and expect good things - do not remove this or risk form bot signups-->
              <div style="position: absolute; left: -5000px;" aria-hidden="true"><input type="text" name="b_45a27b0b6fc6f929b90e35338_89bb6697c0" tabindex="-1" value=""></div>
              <div class="clear"><input type="submit" value="Subscribe" name="subscribe" id="mc-embedded-subscribe" class="ui primary button"></div>
            </div>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>

<div class="ui horizontal divider">
  About Kamran
</div>

<div class="ui items">
  <div class="item">
    <div class="ui small circular image">
      <img src="/assets/images/me.jpg" title="Kamran Ayub">
    </div>

    <div class="content">
      <div class="description">
        <p>I&#x27;m a technologist, speaker, and Pluralsight author and I specialize in building full-stack solutions with a focus on modern web technology and cloud native architecture.</p>
        <p><a href="http://bit.ly/KamranOnPluralsight"><img src="/assets/images/pluralsight.png" alt="Kamran's Pluralsight courses" title="Check out my Pluralsight courses!" style="max-width:80%;margin:1em 0;"></a></p>
      </div>
      <div class="extra">
        <a class="ui circular icon button" href="https://twitter.com/kamranayub" title="Twitter">
  <i class="twitter icon"></i>
</a>
<a class="ui circular icon button" href="https://github.com/kamranayub" title="GitHub">
  <i class="github icon"></i>
</a>
<a class="ui circular icon button" href="https://instagram.com/subkamran" title="Instagram">
  <i class="instagram icon"></i>
</a>
<a class="ui circular icon button" href="http://www.youtube.com/c/Kamranicus " title="YouTube">
  <i class="youtube icon"></i>
</a>
<a class="ui circular icon button" href="https://twitch.tv/kamranicus " title="YouTube">
  <i class="twitch icon"></i>
</a>
<a class="ui circular icon button" href="https://www.linkedin.com/in/subkamran" title="LinkedIn">
  <i class="linkedin icon"></i>
</a>
      </div>
    </div>
  </div>
</div>

<div id="disqus_thread"></div>

<script type="text/javascript">
    var disqus_shortname = 'kamranicus';
    var disqus_identifier = '51';
    var disqus_title = 'Protip: Show DB usage in your EF application';
    var disqus_url = 'https://kamranicus.com/posts/2012-06-15-protip-show-db-usage-in-your-ef-application';

    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
    
    (function () {
        var s = document.createElement('script'); s.async = true;
        s.type = 'text/javascript';
        s.src = '//' + disqus_shortname + '.disqus.com/count.js';
        (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
    }());
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>

      <!-- Disqus -->
<div id="disqus_thread"></div>

<script type="text/javascript">
    var disqus_shortname = 'kamranicus';
    var disqus_identifier = '51';
    var disqus_title = 'Protip: Show DB usage in your EF application';
    var disqus_url = 'https://kamranicus.com/posts/2012-06-15-protip-show-db-usage-in-your-ef-application';

    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
    
    (function () {
        var s = document.createElement('script'); s.async = true;
        s.type = 'text/javascript';
        s.src = '//' + disqus_shortname + '.disqus.com/count.js';
        (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
    }());
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>    </div>
  </div>

  <div class="ui divider"></div>
  
  <!-- Footer -->
  <footer>   
    <div class="ui center aligned container">
  <p class="ui grey sub header">Copyright © Kamran Ayub 2021</p>
  
  <div class="ui basic vertical segment">
    <a class="ui circular icon button" href="https://twitter.com/kamranayub" title="Twitter">
  <i class="twitter icon"></i>
</a>
<a class="ui circular icon button" href="https://github.com/kamranayub" title="GitHub">
  <i class="github icon"></i>
</a>
<a class="ui circular icon button" href="https://instagram.com/subkamran" title="Instagram">
  <i class="instagram icon"></i>
</a>
<a class="ui circular icon button" href="http://www.youtube.com/c/Kamranicus " title="YouTube">
  <i class="youtube icon"></i>
</a>
<a class="ui circular icon button" href="https://twitch.tv/kamranicus " title="YouTube">
  <i class="twitch icon"></i>
</a>
<a class="ui circular icon button" href="https://www.linkedin.com/in/subkamran" title="LinkedIn">
  <i class="linkedin icon"></i>
</a>
  </div>

  <p class="ui basic vertical segment">      
    <a href="http://feeds.feedburner.com/Kamranicus" class="ui right labeled icon button">
      Subscribe via RSS or email
      <i class="right rss icon"></i>
    </a>
  </p>  
  <p class="ui tiny basic vertical segment">
    <a href="https://wyam.io">Statically generated by Wyam</a>
  </p>
</div>

  </footer>

  <script src="https://code.jquery.com/jquery-3.1.1.min.js" integrity="sha256-hVVnYaiADRTO2PzUGmuLJr8BLUSjGIZsDYGmIJLv2b8="
    crossorigin="anonymous"></script>
  <script src="/assets/ui/semantic.min.js"></script>
  <script src="/assets/js/highlight.pack.js"></script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<script>
     (adsbygoogle = window.adsbygoogle || []).push({
          google_ad_client: "ca-pub-6930375300621668",
          enable_page_level_ads: true
     });
</script>

  <script>hljs.initHighlightingOnLoad();</script>
</body>
</html>
