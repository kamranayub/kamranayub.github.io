<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=Edge" />

  <title>Kamranicus - Impersonating a User During Automated Testing Scenarios</title>
  <meta name="description" content="Kamran Ayub" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="author" content="Kamran Ayub">

  <link href="http://feeds.feedburner.com/Kamranicus" rel="alternate" title="Kamranicus (RSS)" type="application/atom+xml">
  <link rel="shortcut icon" href="/favicon.png" type="image/png">
  <link rel="icon" href="/favicon.png" type="image/png">

  <link href="/assets/ui/semantic.min.css" rel="stylesheet" />
  <link href="/assets/css/highlight.css" rel="stylesheet">

  <meta name="application-name" content="Kamranicus" />
  <meta name="msapplication-tooltip" content="Kamranicus" />
  <meta name="msapplication-starturl" content="/" />

  <meta property="og:title" content="Kamranicus - Impersonating a User During Automated Testing Scenarios" /> 
  <meta property="og:type" content="website" />
  <meta property="og:url" content="https://kamranicus.com/posts/2015-11-06-impersonating-during-testing" />
  <meta property="og:site_name" content="Kamranicus" />

  <!-- TODO: More social graph meta tags -->
  <script type="application/ld+json">
  {
      "@context": "http://schema.org",
      "@type": "WebSite",
      "name": "Kamranicus",
      "url": "https://kamranicus.com/",
      "sameAs": [
        "http://www.twitter.com/kamranayub"
      ]
  }
  </script>


  <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
  <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
  <!--[if lt IE 9]>
    <script src="/assets/js/html5shiv.js"></script>
    <script src="/assets/js/respond.min.js"></script>
  <![endif]-->
  <script src="/assets/js/picturefill.min.js" async></script>


  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-1203259-13']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>
  

  


</head>

<body>

  <!-- Navigation -->
  <div class="ui container">
    <nav class="ui huge text site menu">
      
      <a class="header item" href="/">Kamranicus</a>
      
      <div class="ui right item">
              <div class="item">
        <a href="/about">About</a>
      </div>
      <div class="item">
        <a href="/posts">Archive</a>
      </div>
      <div class="item">
        <a href="/guides">Guides</a>
      </div>
      <div class="item">
        <a href="/projects">Projects</a>
      </div>
      <div class="item">
        <a href="/speaking">Speaking</a>
      </div>
      <div class="item">
        <a href="/travel">Travel</a>
      </div>

      </div>
    </nav>
  </div>
  <!-- Page Header -->

  <header class="ui vertical masthead segment" id="intro-header">
    <div class="ui container">

    
<div class="ui basic vertical segment">
    <h1 class="ui huge header">
      Impersonating a User During Automated Testing Scenarios
    </h1>
                
    <div class="ui sub header">        
Published on Friday, November 6, 2015<br>    </div>
        <div class="ui basic vertical spaced segment">
                    <a role="button" href="/tags/net" class="ui small compact button">.NET</a>
                    <a role="button" href="/tags/c%23" class="ui small compact button">C#</a>
                    <a role="button" href="/tags/keep-track-of-my-games" class="ui small compact button">Keep Track of My Games</a>
                    <a role="button" href="/tags/specflow" class="ui small compact button">SpecFlow</a>
                    <a role="button" href="/tags/testing" class="ui small compact button">Testing</a>
        </div>     
</div>
    </div>
  </header>

  <!-- Main Content -->
  <div class="ui stackable grid container">
    <div class="content column">
      

<div class="ui huge basic post content segment">
  <p>I'm starting to introduce privacy controls to <a href="http://keeptrackofmygames.com">Keep Track of My Games</a> and I ran into the following scenario when writing my tests:</p>
<pre><code>Scenario: Anonymous user should be able to view a public custom list
	Given a user has a list
	And a user's list is public
	When I request access to the list
	Then I have read-only access
</code></pre>
<p>In this context, <strong>I</strong> am the anonymous user. This is the exact <a href="http://www.specflow.org/">SpecFlow</a> scenario I wrote. Do you know why I may have run into issues?</p>
<p>Let's look at the first two steps:</p>
<pre><code class="language-c#">[Given(&#64;&quot;a user has a list&quot;)]
public void GivenAUserHasAList() {
    _listResult = _context.ListService.CreateList(_newList)
}

[Given(&#64;&quot;a user's list is public&quot;)]
public void GivenAUsersListIsPublic() {
  _privacySettings.Level = PrivacyLevel.Public;
  _context.ListService.UpdateListPrivacy(_listResult.Id, _privacySettings);
}
</code></pre>
<p>Why would this cause a problem with my given scenario?</p>
<ol>
<li>In the first step, I'm creating a new list.</li>
<li>In the second step, I'm taking the new list I just made from the first step and updating the privacy settings on it.</li>
</ol>
<p>The problem is that my service assumes the context is an authenticated user and will apply changes to the <strong>current user's</strong> list. Well, since I did not call my login helpers before these two steps, I am in an anonymous context so the service calls fail. That's good! But how can I tell my steps to call a service method <em>on behalf</em> of another user without having <em>every</em> step use the current user context?</p>
<p>You might say I should just create a new method that accepts a username and refactor my methods. I <em>could</em> do that but not only is my entire service designed around the current user context, my service layer is essentially the interface of my public API. I would never allow one user to create a list for another user (unless that was a feature). So the same way I wouldn't expose an API method to do something on behalf of someone, I won't add a public method in my service layer to do the same. I could choose to make the method private or internal and grant access to the assembly for testing--true, I <em>could</em> but that seems like a workaround where I need to expose special functionality just for testing.</p>
<p>The approach I ended up doing was simpler and more elegant and leveraged an existing pattern I was relying on: injecting an <code>IUserContext</code> into my service layer like this:</p>
<pre><code class="language-c#">public ListService(IUserContext userContext) {
  _userContext = userContext;
}
</code></pre>
<p>This is using standard dependency injection (Ninject, in my case) to inject a context for the current user. That context gets created and maintained outside this class, so it doesn't care who provided it or where it came from, it just uses it to determine business logic.</p>
<p>So since I'm already injecting the current user context and mocking it in my tests, why not simply swap out the context when I need to?</p>
<h2 id="creating-an-impersonation-context">Creating an impersonation context</h2>
<p>That's what I ended up doing. Here's my implementation of a <code>TestingImpersonationContext</code> (<a href="https://gist.github.com/kamranayub/9654d6581fbcf63cf481">https://gist.github.com/kamranayub/9654d6581fbcf63cf481</a>):</p>
<script src="https://gist.github.com/kamranayub/9654d6581fbcf63cf481.js"></script>
<p>It should be clear what's happening but let me explain further. Specifically in SpecFlow you can inject a context into your testing steps like so:</p>
<pre><code class="language-c#">public class StepBase : TechTalk.SpecFlow.Steps {
    protected TestingContext _context;
    public StepBase(TestingContext context)
    {
        _context = context;
    }
}
</code></pre>
<p>As long as your step classes inherit that <code>StepBase</code>, you have access to a context. All I did was build a method off that context that swapped out my existing dependency that was injected for <code>IUserContext</code> with a temporary context that impersonated the requested user. Once it is disposed, it restores the original context. Easy as pie!</p>
<p>If you are <strong>not</strong> using SpecFlow which is probably the case, don't fret--all you really need is a class or helper method that you can access in your test classes. However you want to achieve that is up to you. Create a base class, don't even bother with dependency injection, etc. This is entirely doable without DI but since my app relies on it I also leverage it during testing.</p>
<p>Now given we have an impersonation context helper, here's how our two testing steps have changed:</p>
<pre><code class="language-c#">[Given(&#64;&quot;a user has a list&quot;)]
public void GivenAUserHasAList() {
  using (_context.Impersonate(&quot;user&quot;) {
    _listResult = _context.ListService.CreateList(_newList);
  }
}

[Given(&#64;&quot;a user's list is public&quot;)]
public void GivenAUsersListIsPublic() {
    using (_context.Impersonate(&quot;user&quot;))
    {
        _privacySettings.Level = PrivacyLevel.Public;
        _context.ListService.UpdateListPrivacy(_listResult.Id, _privacySettings);
    }
}
</code></pre>
<p>I could even update my scenario to be specific about <strong>who's list</strong> I'm accessing (so it's not ambiguous between logged in user vs. another user) but since I only have two users in my testing context, it doesn't really matter.</p>
<p>Now for the test results:</p>
<pre><code>Given a user has a list
-&gt; done: ListSteps.GivenAUserHasAList() (0.2s)
And a user's list is public
-&gt; done: ListSteps.GivenAUsersListIsPublic() (0.0s)
When I request access to the list
-&gt; done: ListSteps.WhenIRequestAccessToTheList() (0.1s)
Then I have read-only access
-&gt; done: ListSteps.ThenIHaveReadAccess() (0.0s)
</code></pre>
<p>The tests are green and now I'm a happy coder. By the way, if you aren't using <a href="http://specflow.org">SpecFlow</a> for .NET you should consider it, I love it.</p>

</div>

<div class="ui horizontal divider">
  About Kamran
</div>

<div class="ui items">
  <div class="item">
    <div class="ui small circular image">
      <img src="/assets/images/me.jpg" title="Kamran Ayub">
    </div>

    <div class="content">
      <div class="description">
        Hi, I&#x27;m a professional full-stack developer who also loves to write, speak at conferences, work on side projects, contribute to open source, make games, and play them.
      </div>
      <div class="extra">
        <a class="ui circular icon button" href="https://twitter.com/kamranayub" title="Twitter">
  <i class="twitter icon"></i>
</a>
<a class="ui circular icon button" href="https://github.com/kamranayub" title="GitHub">
  <i class="github icon"></i>
</a>
<a class="ui circular icon button" href="https://instagram.com/subkamran" title="Instagram">
  <i class="instagram icon"></i>
</a>
<a class="ui circular icon button" href="https://www.youtube.com/channel/UCq6oaAI3ZH2rGlmC9VqJm1g" title="YouTube">
  <i class="youtube icon"></i>
</a>
<a class="ui circular icon button" href="https://www.linkedin.com/in/subkamran" title="LinkedIn">
  <i class="linkedin icon"></i>
</a>
      </div>
    </div>
  </div>
</div>

<div id="disqus_thread"></div>

<script type="text/javascript">
    var disqus_shortname = 'kamranicus';
    var disqus_identifier = 'http://kamranicus.com/blog/2015/11/06/impersonating-during-testing/';
    var disqus_title = 'Impersonating a User During Automated Testing Scenarios';
    var disqus_url = 'https://kamranicus.com/posts/2015-11-06-impersonating-during-testing';

    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
    
    (function () {
        var s = document.createElement('script'); s.async = true;
        s.type = 'text/javascript';
        s.src = '//' + disqus_shortname + '.disqus.com/count.js';
        (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
    }());
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>

      <!-- Disqus -->
<div id="disqus_thread"></div>

<script type="text/javascript">
    var disqus_shortname = 'kamranicus';
    var disqus_identifier = 'http://kamranicus.com/blog/2015/11/06/impersonating-during-testing/';
    var disqus_title = 'Impersonating a User During Automated Testing Scenarios';
    var disqus_url = 'https://kamranicus.com/posts/2015-11-06-impersonating-during-testing';

    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
    
    (function () {
        var s = document.createElement('script'); s.async = true;
        s.type = 'text/javascript';
        s.src = '//' + disqus_shortname + '.disqus.com/count.js';
        (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
    }());
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>    </div>
  </div>

  <div class="ui divider"></div>
  
  <!-- Footer -->
  <footer>   
    <div class="ui center aligned container">
  <p class="ui grey sub header">Copyright Â© Kamran Ayub 2017</p>
  
  <div class="ui basic vertical segment">
    <a class="ui circular icon button" href="https://twitter.com/kamranayub" title="Twitter">
  <i class="twitter icon"></i>
</a>
<a class="ui circular icon button" href="https://github.com/kamranayub" title="GitHub">
  <i class="github icon"></i>
</a>
<a class="ui circular icon button" href="https://instagram.com/subkamran" title="Instagram">
  <i class="instagram icon"></i>
</a>
<a class="ui circular icon button" href="https://www.youtube.com/channel/UCq6oaAI3ZH2rGlmC9VqJm1g" title="YouTube">
  <i class="youtube icon"></i>
</a>
<a class="ui circular icon button" href="https://www.linkedin.com/in/subkamran" title="LinkedIn">
  <i class="linkedin icon"></i>
</a>
  </div>

  <p class="ui basic vertical segment">      
    <a href="http://feeds.feedburner.com/Kamranicus" class="ui right labeled icon button">
      Subscribe via RSS or email
      <i class="right rss icon"></i>
    </a>
  </p>  
  <p class="ui tiny basic vertical segment">
    <a href="https://wyam.io">Statically generated by Wyam</a>
  </p>
</div>

  </footer>

  <script src="https://code.jquery.com/jquery-3.1.1.min.js" integrity="sha256-hVVnYaiADRTO2PzUGmuLJr8BLUSjGIZsDYGmIJLv2b8="
    crossorigin="anonymous"></script>
  <script src="/assets/ui/semantic.min.js"></script>
  <script src="/assets/js/highlight.pack.js"></script>

  

  <script>hljs.initHighlightingOnLoad();</script>
</body>
</html>