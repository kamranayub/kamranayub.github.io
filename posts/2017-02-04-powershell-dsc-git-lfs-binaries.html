<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=Edge" />

  <title>Kamranicus | Kamran Ayub - Store Binaries Next to Powershell DSC Using Git LFS</title>
  <meta name="description" content="Kamran Ayub" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="author" content="Kamran Ayub">

  <link href="http://feeds.feedburner.com/Kamranicus" rel="alternate" title="Kamranicus (RSS)" type="application/atom+xml">
  <link rel="shortcut icon" href="/favicon.png" type="image/png">
  <link rel="icon" href="/favicon.png" type="image/png">

  <link href="/assets/ui/semantic.min.css" rel="stylesheet" />
  <link href="/assets/css/highlight.css" rel="stylesheet">

  <meta name="monetization" content="$ilp.uphold.com/GkRBn6N6hM9q" />
  
  <meta name="application-name" content="Kamranicus | Kamran Ayub" />
  <meta name="msapplication-tooltip" content="Kamranicus | Kamran Ayub" />
  <meta name="msapplication-starturl" content="/" />

  <meta property="og:title" content="Kamranicus | Kamran Ayub - Store Binaries Next to Powershell DSC Using Git LFS" /> 
  <meta property="og:type" content="website" />
  <meta property="og:url" content="https://kamranicus.com/posts/2017-02-04-powershell-dsc-git-lfs-binaries" />
  <meta property="og:site_name" content="Kamranicus" />
  <meta property="twitter:card" content="summary" />
  <meta property="twitter:creator" content="@kamranayub" />

  <!-- TODO: More social graph meta tags -->
  <script type="application/ld+json">
  {
      "@context": "http://schema.org",
      "@type": "WebSite",
      "name": "Kamranicus",
      "url": "https://kamranicus.com/",
      "sameAs": [
        "http://www.twitter.com/kamranayub"
      ]
  }
  </script>


  <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
  <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
  <!--[if lt IE 9]>
    <script src="/assets/js/html5shiv.js"></script>
    <script src="/assets/js/respond.min.js"></script>
  <![endif]-->
  <script src="/assets/js/picturefill.min.js" async></script>

  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-1203259-13']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>
  

  


</head>

<body>

  <!-- Navigation -->
  <div class="ui container">
    <nav class="ui huge text site menu">
      
      <a class="header item" href="/">Kamranicus | Kamran Ayub</a>
      
      <div class="ui right item">
              <div class="item">
        <a href="/about">Contact</a>
      </div>
      <div class="item">
        <a href="/events">Events</a>
      </div>
      <div class="item">
        <a href="/guides">Guides</a>
      </div>
      <div class="item">
        <a href="/projects">Projects</a>
      </div>
      <div class="item">
        <a href="/training">Training</a>
      </div>
      <div class="item">
        <a href="/travel">Travel</a>
      </div>

      </div>
    </nav>
  </div>
  <!-- Page Header -->

  <header class="ui vertical masthead segment  " id="intro-header">
    <div class="ui container">

    
<div class="ui basic vertical segment">
    <h1 class="ui  huge header">
      Store Binaries Next to Powershell DSC Using Git LFS
        <div class="ui sub header">Keep your Powershell DSC scripts and dependent binaries together using Git Large File Storage (LFS)</div>
    </h1>
                
    <div class="ui  sub header">        
Published on Saturday, February 4, 2017<br>    </div>
        <div class="ui basic vertical spaced segment">
                    <a role="button" href="/tags/Automation" class="ui small compact button">Automation</a>
                    <a role="button" href="/tags/DevOps" class="ui small compact button">DevOps</a>
                    <a role="button" href="/tags/DSC" class="ui small compact button">DSC</a>
                    <a role="button" href="/tags/Git" class="ui small compact button">Git</a>
                    <a role="button" href="/tags/TFS" class="ui small compact button">TFS</a>
        </div>     
</div>
    </div>
  </header>

  <!-- Main Content -->
  <div class="ui stackable grid container">
    <div class="content column">
      

<div class="ui huge basic post content segment">
  <p>A common need when configuring servers using <a href="https://msdn.microsoft.com/en-us/powershell/dsc/overview">Powershell DSC</a> is installing software or copying binary files, for example, installing the Java SDK, Sysinternals, MSI installers, or what have you.</p>
<!-- More -->
<h2 id="updates">Updates</h2>
<ul>
<li><strong>6/14/2017</strong>: My good friend and colleague <a href="https://erikonarheim.com">Erik</a> was going through this exercise at work and let me know the code doesn't <em>actually</em> work. Whoops! Apparently when I tested, the binaries weren't actually in Git LFS since I had already checked them in. However, I did manage to solve the issue but for now you may need to use a custom Script resource until I release a DSC module. <a href="/posts/2017-06-14-downloading-git-lfs-files-from-tfs-vsts">Check out this post</a> for an explanation and solution. I will update this post again with my new resource once available.</li>
</ul>
<h2 id="using-a-network-share">Using a network share</h2>
<p>Depending on the software, there are multiple ways to do the installation--using the <a href="https://msdn.microsoft.com/en-us/powershell/dsc/packageresource">Package</a> resource, copying files/manipulating the registry, etc. Common to all cases is the fact you need a <em>source</em> of the installation. Typically this is an exe, msi, zip, or some other large binary file.</p>
<p>If I asked you where to store common installation source files that need to be accessible by any arbitrary server for DSC, you might (rightly) say, &quot;A network share!&quot; This is where most articles on using DSC stop.</p>
<p>You would do something like this, such as copying a zip file from the share to a target node:</p>
<pre><code class="language-powershell">Configuration WebServer {
  Param($Credential)

  File EnsureSysinternalsIsPresentInInstallationSource {
    Ensure = &quot;Present&quot;
    DestinationPath = &quot;C:\DSC\Sources\SysInternalsSuite-2016-11-18.zip&quot;
    SourcePath = &quot;\\contoso.com\DSC\Sources\SysInternalsSuite-2016-11-18.zip&quot;
    Credential = $Credential
  }

  Archive EnsureSysInternalsIsInstalled {
    Ensure = &quot;Present&quot;
    Destination = &quot;C:\Utilities\Sysinternals&quot;
    Path = &quot;C:\DSC\Sources\SysInternalsSuite-2016-11-18.zip&quot;
  }

}
</code></pre>
<p>Here we are copying the Sysinternals source archive to the target node for extraction. The network share is secured to some credential we've passed in.</p>
<p>In some cases, some DSC resources allow using UNC paths as their source but I've found this to be inconsistently implemented, finicky and riddled with permission issues, especially when doing complex installations that may require manual scripting. Behind the scenes Powershell has to mount the remote share and you can run into strange issues because of this--hours and days have been spent diagnosing network issues only to come down to black magic AD configuration. I've been burned too often to recommend this approach.</p>
<h2 id="binaries-are-configuration-too">Binaries are configuration too</h2>
<p>There's another issue. As a developer who moved into a more operational role (DevOps!), I've made it a point to store all our DSC in source control (Git, specifically). So now I'm in a situation where all my configuration is versioned and in source control but my installation sources or other binaries are stored separately in a file share.</p>
<p>I don't like it. You should <em>store things that relate together next to each other.</em> If you don't, it introduces extra complexity:</p>
<ul>
<li>I need to ensure the entire team can access the file share</li>
<li>Anyone could accidentally remove or change a file in the share and kill our DSC</li>
<li>I need to document the sources somewhere in the repository</li>
<li>The installation source files are not versioned or audited</li>
<li>As mentioned above, your mileage may vary with access to network resources</li>
</ul>
<p>The fact is installation binaries <em>are still configuration.</em> Changes to the installation sources go hand-in-hand with changes to your DSC because they are married together. In your Git history, you want a record <strong>of all changes to any aspect of your configuration.</strong></p>
<h2 id="using-git-lfs-to-store-binaries">Using Git LFS to store binaries</h2>
<p>Normally storing binaries in Git isn't a recommended approach. Git wasn't designed for gigabye repositories. However, there's an extension available called <a href="https://git-lfs.github.com/">Git Large File Storage (LFS)</a>. It supports gigabye files and reduces repository size by storing the binaries on the remote server.</p>
<p>Since we're using TFS, <a href="https://www.visualstudio.com/en-us/docs/git/manage-large-files">Git LFS is supported</a>. It's also supported on pretty much every major Git hosting provider. The only dependency is that local development requires you to install the Git LFS extension--something easily put into the README of the repository.</p>
<p>Once you configure Git LFS for a repository:</p>
<pre><code>git lfs track &quot;*.zip&quot;
git lfs track &quot;*.exe&quot;
git lfs track &quot;*.msi&quot;
</code></pre>
<p>You can now add these binary files and they'll be tracked in Git LFS (track whatever you need).</p>
<p>Let's say for our purposes our repository now looks like this:</p>
<pre><code>configuration/WebServer.ps1
installers/sysinternals/SysInternalsSuite-2016-11-18.zip
</code></pre>
<p>Now you can efficiently store binary files alongside your configuration files!</p>
<h2 id="downloading-installers-during-dsc-pull">Downloading Installers During DSC Pull</h2>
<p>We're using DSC pull, which is the recommended approach for using DSC if you want to scale it out across your clusters. How does our DSC change now that we're storing the installers side-by-side?</p>
<p>Presumably, you've managed to get your configs over to the pull server (which is a series of articles I still intend to write), but your installers are still stored in Git. What to do?</p>
<p>Instead of copying files from a share, we can use some APIs available to use in TFS (or GitHub or what have you) to <strong>download the installers locally.</strong></p>
<p>The TFS Rest API is documented and you can see there's a way to <a href="https://www.visualstudio.com/en-us/docs/integrate/api/git/items#get-a-file">download a folder as a zip file or stream a file</a>--which is perfect!</p>
<p>For TFS, the format of the URL is like this:</p>
<pre><code>GET https://{instance}/DefaultCollection/{project}/_apis/git/repositories/{repository}/items?api-version={version}&amp;scopePath={itemPath}
</code></pre>
<p>To get a specific <em>branch</em> (in cases where different branches are for different environments), you can pass <code>&amp;versionType=branch&amp;version={branch}</code>.</p>
<p>This works for on-premise TFS and VSTS. There are <a href="https://developer.github.com/v3/repos/contents/#get-archive-link">similar APIs</a> for GitHub.</p>
<p>Using the <a href="https://github.com/PowerShell/xPSDesiredStateConfiguration#xremotefile">xRemoteFile</a> resource, we can bring down our dependencies to the local machine to use, so our configuration above would change:</p>
<pre><code class="language-powershell">Configuration WebServer {
  Param($Credential)

  Import-DscResource -Name xPSDesiredStateConfiguration 

  xRemoteFile EnsureSysinternalsIsPresentInInstallationSource {
    DestinationPath = &quot;C:\DSC\Sources\SysInternalsSuite-2016-11-18.zip&quot;
    Uri = &quot;https://tfs.contoso.com/tfs/DefaultCollection/TeamProject/_apis/git/repositories/DSC/items?api-version=1.0&amp;scopePath=installers/sysinternals/SysInternalsSuite-2016-11-18.zip&quot;
    Credential = $Credential
    MatchSource = $True
  }

  Archive EnsureSysInternalsIsInstalled {
    Ensure = &quot;Present&quot;
    Destination = &quot;C:\Utilities\Sysinternals&quot;
    Path = &quot;C:\DSC\Sources\SysInternalsSuite-2016-11-18.zip&quot;
  }

}
</code></pre>
<p>To use <code>xRemoteFile</code> we need to import the xPSDesiredStateConfiguration DSC module <a href="https://msdn.microsoft.com/en-us/powershell/dsc/pullserver#placing-configurations-and-resources">which has to be stored</a> on the pull server. Then we can use the appropriate URL to download an individual installer, or we could have downloaded the zip of the <strong>installers</strong> folder and unzipped it locally. The <code>MatchSource</code> parameter should prevent re-downloading the file if it already exists (and we added the version to the zip file). We are still passing a <code>Credential</code> because your source control repository is probably still authenticated.</p>
<blockquote class="blockquote">
<p><strong>Attention Reader:</strong> This actually doesn't work when using Git LFS. You have to <a href="/posts/2017-06-14-downloading-git-lfs-files-from-tfs-vsts">shave some yaks</a> before you can get it to work.</p>
</blockquote>
<p>If you needed something more sophisticated, you could wrap downloading into a custom resource or Script resource--e.g. <a href="https://www.visualstudio.com/en-us/docs/integrate/api/git/items#get-item-metadata-for">use the SHA1 hash</a> to compare whether it needed to be downloaded again, etc. Where you go from here is your own choice!</p>
<p>We've been using this pattern with great success--it keeps everything together, it's simple, and it lets us track the versions/history of our installation sources.</p>

</div>

<h3 class="ui horizontal divider">
  Don't miss any updates!
</h3>

<div class="ui two column mobile tablet computer reversed divided grid">
  <div class="row">
    <div class="column">
      <p class="ui text tiny"><em>No spam and I usually send a newsletter once a quarter with content you won't see on the blog.</em></p>
    </div>
    <div class="column">
      <div class="ui items" id="mc_embed_signup">
        <form action="https://kamranicus.us18.list-manage.com/subscribe/post?u=45a27b0b6fc6f929b90e35338&amp;id=89bb6697c0" method="post" id="mc-embedded-subscribe-form" name="mc-embedded-subscribe-form" class="validate" target="_blank" novalidate>
          <div class="item" id="mc_embed_signup_scroll">
            <div class="content">
              <div class="ui input">
                <input type="email" value="" name="EMAIL" placeholder="Your Email" class="required email" id="mce-EMAIL">
              </div>
              <div id="mce-responses" class="clear" style="margin-top: 1em;">
                <div class="response" id="mce-error-response" style="display:none"></div>
                <div class="response" id="mce-success-response" style="display:none"></div>
              </div>    <!-- real people should not fill this in and expect good things - do not remove this or risk form bot signups-->
              <div style="position: absolute; left: -5000px;" aria-hidden="true"><input type="text" name="b_45a27b0b6fc6f929b90e35338_89bb6697c0" tabindex="-1" value=""></div>
              <div class="clear"><input type="submit" value="Subscribe" name="subscribe" id="mc-embedded-subscribe" class="ui primary button"></div>
            </div>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>

<div class="ui horizontal divider">
  About Kamran
</div>

<div class="ui items">
  <div class="item">
    <div class="ui small circular image">
      <img src="/assets/images/me.jpg" title="Kamran Ayub">
    </div>

    <div class="content">
      <div class="description">
        <p>I&#x27;m a technologist, speaker, and Pluralsight author and I specialize in building full-stack solutions with a focus on modern web technology and cloud native architecture.</p>
        <p><a href="http://bit.ly/KamranOnPluralsight"><img src="/assets/images/pluralsight.png" alt="Kamran's Pluralsight courses" title="Check out my Pluralsight courses!" style="max-width:80%;margin:1em 0;"></a></p>
      </div>
      <div class="extra">
        <a class="ui circular icon button" href="https://twitter.com/kamranayub" title="Twitter">
  <i class="twitter icon"></i>
</a>
<a class="ui circular icon button" href="https://github.com/kamranayub" title="GitHub">
  <i class="github icon"></i>
</a>
<a class="ui circular icon button" href="https://instagram.com/subkamran" title="Instagram">
  <i class="instagram icon"></i>
</a>
<a class="ui circular icon button" href="https://www.youtube.com/channel/UCq6oaAI3ZH2rGlmC9VqJm1g " title="YouTube">
  <i class="youtube icon"></i>
</a>
<a class="ui circular icon button" href="https://twitch.tv/kamranicus " title="YouTube">
  <i class="twitch icon"></i>
</a>
<a class="ui circular icon button" href="https://www.linkedin.com/in/subkamran" title="LinkedIn">
  <i class="linkedin icon"></i>
</a>

      </div>
    </div>
  </div>
</div>

<div id="disqus_thread"></div>

<script type="text/javascript">
    var disqus_shortname = 'kamranicus';
    var disqus_identifier = '2017-02-04-powershell-dsc-git-lfs-binaries';
    var disqus_title = 'Store Binaries Next to Powershell DSC Using Git LFS';
    var disqus_url = 'https://kamranicus.com/posts/2017-02-04-powershell-dsc-git-lfs-binaries';

    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
    
    (function () {
        var s = document.createElement('script'); s.async = true;
        s.type = 'text/javascript';
        s.src = '//' + disqus_shortname + '.disqus.com/count.js';
        (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
    }());
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>

      <!-- Disqus -->
    </div>
  </div>

  <div class="ui divider"></div>
  
  <!-- Footer -->
  <footer>   
    <div class="ui center aligned container">
  <p class="ui grey sub header">Copyright © Kamran Ayub 2021</p>
  
  <div class="ui basic vertical segment">
    <a class="ui circular icon button" href="https://twitter.com/kamranayub" title="Twitter">
  <i class="twitter icon"></i>
</a>
<a class="ui circular icon button" href="https://github.com/kamranayub" title="GitHub">
  <i class="github icon"></i>
</a>
<a class="ui circular icon button" href="https://instagram.com/subkamran" title="Instagram">
  <i class="instagram icon"></i>
</a>
<a class="ui circular icon button" href="https://www.youtube.com/channel/UCq6oaAI3ZH2rGlmC9VqJm1g " title="YouTube">
  <i class="youtube icon"></i>
</a>
<a class="ui circular icon button" href="https://twitch.tv/kamranicus " title="YouTube">
  <i class="twitch icon"></i>
</a>
<a class="ui circular icon button" href="https://www.linkedin.com/in/subkamran" title="LinkedIn">
  <i class="linkedin icon"></i>
</a>

  </div>

  <p class="ui basic vertical segment">      
    <a href="http://feeds.feedburner.com/Kamranicus" class="ui right labeled icon button">
      Subscribe via RSS or email
      <i class="right rss icon"></i>
    </a>
  </p>  
  <p class="ui tiny basic vertical segment">
    <a href="https://wyam.io">Statically generated by Wyam</a>
  </p>
</div>

  </footer>

  <script src="https://code.jquery.com/jquery-3.1.1.min.js" integrity="sha256-hVVnYaiADRTO2PzUGmuLJr8BLUSjGIZsDYGmIJLv2b8="
    crossorigin="anonymous"></script>
  <script src="/assets/ui/semantic.min.js"></script>
  <script src="/assets/js/highlight.pack.js"></script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<script>
     (adsbygoogle = window.adsbygoogle || []).push({
          google_ad_client: "ca-pub-6930375300621668",
          enable_page_level_ads: true
     });
</script>

  <script>hljs.initHighlightingOnLoad();</script>
</body>
</html>
