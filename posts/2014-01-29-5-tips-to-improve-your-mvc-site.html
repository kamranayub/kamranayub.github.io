<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=Edge" />

  <title>Kamranicus | Kamran Ayub - 5 Tips to Improve Your ASP.NET MVC Codebase</title>
  <meta name="description" content="Kamran Ayub" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="author" content="Kamran Ayub">

  <link href="http://feeds.feedburner.com/Kamranicus" rel="alternate" title="Kamranicus (RSS)" type="application/atom+xml">
  <link rel="shortcut icon" href="/favicon.png" type="image/png">
  <link rel="icon" href="/favicon.png" type="image/png">

  <link href="/assets/ui/semantic.min.css" rel="stylesheet" />
  <link href="/assets/css/highlight.css" rel="stylesheet">

  <meta name="monetization" content="$ilp.uphold.com/GkRBn6N6hM9q" />
  
  <meta name="application-name" content="Kamranicus | Kamran Ayub" />
  <meta name="msapplication-tooltip" content="Kamranicus | Kamran Ayub" />
  <meta name="msapplication-starturl" content="/" />

  <meta property="og:title" content="Kamranicus | Kamran Ayub - 5 Tips to Improve Your ASP.NET MVC Codebase" /> 
  <meta property="og:type" content="website" />
  <meta property="og:url" content="https://kamranicus.com/posts/2014-01-29-5-tips-to-improve-your-mvc-site" />
  <meta property="og:site_name" content="Kamranicus" />
  <meta property="twitter:card" content="summary" />
  <meta property="twitter:creator" content="@kamranayub" />

  <!-- TODO: More social graph meta tags -->
  <script type="application/ld+json">
  {
      "@context": "http://schema.org",
      "@type": "WebSite",
      "name": "Kamranicus",
      "url": "https://kamranicus.com/",
      "sameAs": [
        "http://www.twitter.com/kamranayub"
      ]
  }
  </script>


  <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
  <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
  <!--[if lt IE 9]>
    <script src="/assets/js/html5shiv.js"></script>
    <script src="/assets/js/respond.min.js"></script>
  <![endif]-->
  <script src="/assets/js/picturefill.min.js" async></script>

  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-1203259-13']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>
  

  


</head>

<body>

  <!-- Navigation -->
  <div class="ui container">
    <nav class="ui huge text site menu">
      
      <a class="header item" href="/">Kamranicus | Kamran Ayub</a>
      
      <div class="ui right item">
              <div class="item">
        <a href="/about">Contact</a>
      </div>
      <div class="item">
        <a href="/events">Events</a>
      </div>
      <div class="item">
        <a href="/guides">Guides</a>
      </div>
      <div class="item">
        <a href="/projects">Projects</a>
      </div>
      <div class="item">
        <a href="/training">Training</a>
      </div>
      <div class="item">
        <a href="/travel">Travel</a>
      </div>

      </div>
    </nav>
  </div>
  <!-- Page Header -->

  <header class="ui vertical masthead segment  " id="intro-header">
    <div class="ui container">

    
<div class="ui basic vertical segment">
    <h1 class="ui  huge header">
      5 Tips to Improve Your ASP.NET MVC Codebase
    </h1>
                
    <div class="ui  sub header">        
Published on Wednesday, January 29, 2014<br>    </div>
        <div class="ui basic vertical spaced segment">
                    <a role="button" href="/tags/ASPNET" class="ui small compact button">ASP.NET</a>
                    <a role="button" href="/tags/MVC" class="ui small compact button">MVC</a>
                    <a role="button" href="/tags/Tips" class="ui small compact button">Tips</a>
        </div>     
</div>
    </div>
  </header>

  <!-- Main Content -->
  <div class="ui stackable grid container">
    <div class="content column">
      

<div class="ui huge basic post content segment">
  <p>I have an urge to write a quick list of tips for improving an ASP.NET MVC application because
I just got done reviewing some code for a support ticket at work. It's still fresh
in my mind and I wanted to get some of my thoughts down to share with others. If you
have been doing MVC for a while, I don't think much of this is news. It's more
for those of you that don't do MVC often or are new to MVC.</p>
<!-- More -->
<p>Imagine this: you've been tasked to figure out why a web application is using 2GB of memory on the
production web servers. You pull down the version that's currently in production and run it locally
to profile and debug.</p>
<p>After looking through the code, doing some profiling, maybe shaking your head a bit, you've figured
out what the issue is and now you need to give some feedback.</p>
<p>That's exactly what happened to me today and out of that experience, 5 tips you can follow to keep
your ASP.NET MVC codebase working as you'd expect.</p>
<h3 id="understand-the-queries-in-your-problem-domain">1. Understand the queries in your problem domain</h3>
<p>The root cause of the support ticket I received was a simple case of fetching too much
data from the database, causing obscene amounts of memory usage.</p>
<p>It's a common enough issue. You're building a simple blog, it has posts and it has media (images, videos, attachments).
You put a Media array onto your Post domain object. Your Media domain object has all the image
data stored in a byte array. Since you're using an ORM, there's a certain way you need to design your domain model
to play nice; we've all experienced this.</p>
<pre><code class="language-c#">public class BlogPost {
	
	public ICollection&lt;BlogMedia&gt; Media { get; set; }

}

public class BlogMedia {
	
	public byte[] Data { get; set; }

	public string Name { get; set; }

}
</code></pre>
<p>There's nothing absolutely wrong with this design. You've modeled your domain accurately. The problem is, when you
issue a query through your favorite ORM, it eagerly loads all the data associated with your blog post:</p>
<pre><code class="language-c#">public IList&lt;BlogPost&gt; GetNewestPosts(int take) {
	return _db.BlogPosts.OrderByDescending(p =&gt; p.PostDate).Take(take).ToList();
}
</code></pre>
<p>A seemingly innocuous line (unless you've been bitten), a sneaky monster is lying in wait with big consequences if you haven't disabled
lazy loading or didn't tell your ORM to ignore that big <code>Data</code> property on blog media.</p>
<p>It's important to understand how your ORM queries and maps objects and make sure you only query what you need (for example using projection).</p>
<pre><code class="language-c#">public IList&lt;PostSummary&gt; GetNewestPosts(int take) {
	return _db.BlogPosts.OrderByDescending(p =&gt; p.PostDate).Take(take).Select(p =&gt; new PostSummary() {
		Title = p.Title,
		Id = p.Id
	}).ToList();
}
</code></pre>
<p>This ensures we only grab the amount of data we really need for the task. If all you're doing is using the title and ID to build a link on the homepage, <em>just ask</em>.</p>
<p>It's OK to have more than 5 methods on a repository; be as granular as you need to be for your UI.</p>
<h3 id="dont-call-your-repositories-from-your-views">2. Don't call your repositories from your views</h3>
<p>This one's a little sneaky. Consider this line in an MVC view:</p>
<pre><code class="language-c#">&#64;foreach(var post in Model.RelatedPosts) {
	...
}
</code></pre>
<p>It <em>seems</em> innocent enough. But if we take a look at what exactly that model property is hiding:</p>
<pre><code class="language-c#">public class MyViewModel {
	
	public IList&lt;BlogPost&gt; RelatedPosts {
		get { return new BlogRepository().GetRelatedPosts(this.Tags); }
	}

}
</code></pre>
<p>Yikes! Your &quot;view model&quot; has business logic in it on top of calling a data access method directly. Now you've introduced data
access code somewhere it doesn't belong and hidden it inside a property. Move that into the controller so you can wrangle it in
and populate the view model conciously.</p>
<p>This is a good opportunity to point out that implementing proper unit tests would uncover issues like this; because you definitely can't intercept calls to something like that and then you'd realize injecting a repository into a view model is probably not something you want to be doing.</p>
<h3 id="use-partials-and-child-actions-to-your-advantage">3. Use partials and child actions to your advantage</h3>
<p>If you need to perform business logic in a view, that should be a sign you need to revisit your view model and logic.
I don't think it's advisable to do this in your MVC Razor view:</p>
<pre><code class="language-c#">&#64;{
	var blogController = new BlogController();
}

&lt;ul&gt;
&#64;foreach(var tag in blogController.GetTagsForPost(p.Id)) {
	&lt;li&gt;&#64;tag.Name&lt;/li&gt;
}
&lt;/ul&gt;
</code></pre>
<p>Putting business logic in the view is a no-no, but on top of that you're creating a <em>controller</em>! Move that into your action method and use
that view model you made for what it's intended for. You can also move that logic into a separate action method that only gets called inside views
so you can cache it separately if needed.</p>
<pre><code class="language-c#">//In the controller:

[ChildActionOnly]
[OutputCache(Duration=2000)]
public ActionResult TagsForPost(int postId) {
	return View();
}

//In the view:

&#64;{Html.RenderAction(&quot;TagsForPost&quot;, new { postId = p.Id });}
</code></pre>
<p>Notice the <code>ChildActionOnly</code> attribute. From <a href="http://msdn.microsoft.com/en-us/library/system.web.mvc.childactiononlyattribute(v=vs.118).aspx">MSDN</a>:</p>
<blockquote class="blockquote">
<p>Any method that is marked with <code>ChildActionOnlyAttribute</code> can be called only with the <code>Action</code> or <code>RenderAction</code> HTML extension methods.</p>
</blockquote>
<p>This means people can't see your child action by manipulating the URL (if you're using the default route).</p>
<p>Partial views and child actions are useful tools in the MVC arsenal; use them to your advantage!</p>
<h3 id="cache-what-matters">4. Cache what matters</h3>
<p>Given the code smells above, what do you think will happen if you only cached your view model?</p>
<pre><code class="language-c#">public ActionResult Index() {
	var homepageViewModel = HttpContext.Current.Cache[&quot;homepageModel&quot;] as HomepageViewModel;

	if (homepageViewModel == null) {
		homepageViewModel = new HomepageViewModel();
		homepageViewModel.RecentPosts = _blogRepository.GetNewestPosts(5);

		HttpContext.Current.Cache.Add(&quot;homepageModel&quot;, homepageViewModel, ...);

	}

	return View(homepageViewModel);
}
</code></pre>
<p>Nothing! There will not be any performance gain because you're accessing the data layer through a controller variable in the view and
through a property in the view model... caching the view model won't help anything.</p>
<p>Instead, consider caching the <em>output</em> of the MVC action instead:</p>
<pre><code class="language-c#">[OutputCache(Duration=2000)]
public ActionResult Index() {
	var homepageViewModel = new HomepageViewModel();

	homepageViewModel.RecentPosts = _blogRepository.GetNewestPosts(5);

	return View(homepageViewModel);
}
</code></pre>
<p>Notice the handy <code>OutputCache</code> attribute. MVC supports ASP.NET Output Caching; use it to your advantage when it applies. If you are
going to cache the model, your model needs to essentially be a POCO with automatic (and read-only) properties... not something that calls other
repository methods.</p>
<p>As an added benefit, I haven't ever done this but you can <a href="http://msdn.microsoft.com/en-us/magazine/gg650661.aspx">implement different output caching providers</a> allowing you to cache on
AppFabric/NoSQL/anywhere if you ever needed it. MVC is super extensible.</p>
<h3 id="dont-be-afraid-to-leverage-your-orm">5. Don't be afraid to leverage your ORM</h3>
<p>If you're not going to take advantage of your ORM's feature set, you are missing out. In the codebase
I was reviewing, they were using NHibernate but they weren't <em>using</em> it. They were totally missing out on <a href="http://nhforge.org/doc/nh/en/index.html#querycriteria-projection">its advanced projection
capabilities</a> to solve some of these memory issues. Some of this stems from rigidity in using a &quot;repository pattern&quot; and some of it stems from lack of knowledge.</p>
<p>By taking advantage of EF or NHibernate's features, your repositories can do a lot more than just use basic generic methods. They can shape and
return the data <em>you actually want</em> in your controllers, greatly simplifying your controller logic. Do yourself a favor and read through the ORM's documentation to get a handle on what it can offer.</p>
<p>I think when people adopt the repository pattern, it's almost like they pull down a shade over the bright light shining in from their ORM window. When I started playing with RavenDB, I <strong>got rid</strong> of my repository layer (in fact, my <em>entire data project</em>) and went full-metal using Raven queries in my application service layer with a little bit of extension methods to reuse query logic. I found that <em>a lot</em> of my logic was really context-specific and benefited from simply taking advantage of Raven's extensive features to project, shape, and batch my queries.</p>
<h4 id="thats-just-like-your-opinion-man">That's just, like, your opinion man...</h4>
<p>If you think you can abstract your ORM, I challenge you to think about it differently. The ORM <em>is</em> your abstraction and if you believe swapping out your existing ORM with another ORM will be a piece of cake because it's &quot;abstracted&quot;, you'd be surprised. That's what I thought too until I learned the hard way that switching to Raven really changed my entire codebase in ways I didn't expect. Your ORM doesn't only affect data access, it affects the domain and it affects your business logic, it even will have an effect on your UI. By removing the repository abstraction, I actually <em>reduced the overall complexity</em> of my data access code.</p>
<h3 id="common-sense-is-not-so-common">&quot;Common sense is not so common&quot;</h3>
<p>Or so my dad loves to remind me at times. Sometimes it just takes a good code review to remind oneself that what you thought everyone knew isn't the case; you probably learned it through experience or frantic Googling and just assumed other people already knew it.</p>
<p>I hope this helped someone else out!</p>

</div>

<h3 class="ui horizontal divider">
  Don't miss any updates!
</h3>

<div class="ui two column mobile tablet computer reversed divided grid">
  <div class="row">
    <div class="column">
      <p class="ui text tiny"><em>No spam and I usually send a newsletter once a quarter with content you won't see on the blog.</em></p>
    </div>
    <div class="column">
      <div class="ui items" id="mc_embed_signup">
        <form action="https://kamranicus.us18.list-manage.com/subscribe/post?u=45a27b0b6fc6f929b90e35338&amp;id=89bb6697c0" method="post" id="mc-embedded-subscribe-form" name="mc-embedded-subscribe-form" class="validate" target="_blank" novalidate>
          <div class="item" id="mc_embed_signup_scroll">
            <div class="content">
              <div class="ui input">
                <input type="email" value="" name="EMAIL" placeholder="Your Email" class="required email" id="mce-EMAIL">
              </div>
              <div id="mce-responses" class="clear" style="margin-top: 1em;">
                <div class="response" id="mce-error-response" style="display:none"></div>
                <div class="response" id="mce-success-response" style="display:none"></div>
              </div>    <!-- real people should not fill this in and expect good things - do not remove this or risk form bot signups-->
              <div style="position: absolute; left: -5000px;" aria-hidden="true"><input type="text" name="b_45a27b0b6fc6f929b90e35338_89bb6697c0" tabindex="-1" value=""></div>
              <div class="clear"><input type="submit" value="Subscribe" name="subscribe" id="mc-embedded-subscribe" class="ui primary button"></div>
            </div>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>

<div class="ui horizontal divider">
  About Kamran
</div>

<div class="ui items">
  <div class="item">
    <div class="ui small circular image">
      <img src="/assets/images/me.jpg" title="Kamran Ayub">
    </div>

    <div class="content">
      <div class="description">
        <p>I&#x27;m a technologist, speaker, and Pluralsight author and I specialize in building full-stack solutions with a focus on modern web technology and cloud native architecture.</p>
        <p><a href="http://bit.ly/KamranOnPluralsight"><img src="/assets/images/pluralsight.png" alt="Kamran's Pluralsight courses" title="Check out my Pluralsight courses!" style="max-width:80%;margin:1em 0;"></a></p>
      </div>
      <div class="extra">
        <a class="ui circular icon button" href="https://twitter.com/kamranayub" title="Twitter">
  <i class="twitter icon"></i>
</a>
<a class="ui circular icon button" href="https://github.com/kamranayub" title="GitHub">
  <i class="github icon"></i>
</a>
<a class="ui circular icon button" href="https://instagram.com/subkamran" title="Instagram">
  <i class="instagram icon"></i>
</a>
<a class="ui circular icon button" href="http://www.youtube.com/c/Kamranicus " title="YouTube">
  <i class="youtube icon"></i>
</a>
<a class="ui circular icon button" href="https://twitch.tv/kamranicus " title="YouTube">
  <i class="twitch icon"></i>
</a>
<a class="ui circular icon button" href="https://www.linkedin.com/in/subkamran" title="LinkedIn">
  <i class="linkedin icon"></i>
</a>
      </div>
    </div>
  </div>
</div>

<div id="disqus_thread"></div>

<script type="text/javascript">
    var disqus_shortname = 'kamranicus';
    var disqus_identifier = 'http://kamranicus.com/blog/2014/01/29/5-tips-to-improve-your-mvc-site/';
    var disqus_title = '5 Tips to Improve Your ASP.NET MVC Codebase';
    var disqus_url = 'https://kamranicus.com/posts/2014-01-29-5-tips-to-improve-your-mvc-site';

    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
    
    (function () {
        var s = document.createElement('script'); s.async = true;
        s.type = 'text/javascript';
        s.src = '//' + disqus_shortname + '.disqus.com/count.js';
        (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
    }());
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>

      <!-- Disqus -->
<div id="disqus_thread"></div>

<script type="text/javascript">
    var disqus_shortname = 'kamranicus';
    var disqus_identifier = 'http://kamranicus.com/blog/2014/01/29/5-tips-to-improve-your-mvc-site/';
    var disqus_title = '5 Tips to Improve Your ASP.NET MVC Codebase';
    var disqus_url = 'https://kamranicus.com/posts/2014-01-29-5-tips-to-improve-your-mvc-site';

    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
    
    (function () {
        var s = document.createElement('script'); s.async = true;
        s.type = 'text/javascript';
        s.src = '//' + disqus_shortname + '.disqus.com/count.js';
        (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
    }());
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>    </div>
  </div>

  <div class="ui divider"></div>
  
  <!-- Footer -->
  <footer>   
    <div class="ui center aligned container">
  <p class="ui grey sub header">Copyright © Kamran Ayub 2021</p>
  
  <div class="ui basic vertical segment">
    <a class="ui circular icon button" href="https://twitter.com/kamranayub" title="Twitter">
  <i class="twitter icon"></i>
</a>
<a class="ui circular icon button" href="https://github.com/kamranayub" title="GitHub">
  <i class="github icon"></i>
</a>
<a class="ui circular icon button" href="https://instagram.com/subkamran" title="Instagram">
  <i class="instagram icon"></i>
</a>
<a class="ui circular icon button" href="http://www.youtube.com/c/Kamranicus " title="YouTube">
  <i class="youtube icon"></i>
</a>
<a class="ui circular icon button" href="https://twitch.tv/kamranicus " title="YouTube">
  <i class="twitch icon"></i>
</a>
<a class="ui circular icon button" href="https://www.linkedin.com/in/subkamran" title="LinkedIn">
  <i class="linkedin icon"></i>
</a>
  </div>

  <p class="ui basic vertical segment">      
    <a href="http://feeds.feedburner.com/Kamranicus" class="ui right labeled icon button">
      Subscribe via RSS or email
      <i class="right rss icon"></i>
    </a>
  </p>  
  <p class="ui tiny basic vertical segment">
    <a href="https://wyam.io">Statically generated by Wyam</a>
  </p>
</div>

  </footer>

  <script src="https://code.jquery.com/jquery-3.1.1.min.js" integrity="sha256-hVVnYaiADRTO2PzUGmuLJr8BLUSjGIZsDYGmIJLv2b8="
    crossorigin="anonymous"></script>
  <script src="/assets/ui/semantic.min.js"></script>
  <script src="/assets/js/highlight.pack.js"></script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<script>
     (adsbygoogle = window.adsbygoogle || []).push({
          google_ad_client: "ca-pub-6930375300621668",
          enable_page_level_ads: true
     });
</script>

  <script>hljs.initHighlightingOnLoad();</script>
</body>
</html>
