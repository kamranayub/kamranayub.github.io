<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=Edge" />

  <title>Kamranicus - Generating an Encryption Certificate for PowerShell DSC in WMF5</title>
  <meta name="description" content="Kamran Ayub" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="author" content="Kamran Ayub">

  <link href="http://feeds.feedburner.com/Kamranicus" rel="alternate" title="Kamranicus (RSS)" type="application/atom+xml">
  <link rel="shortcut icon" href="/favicon.png" type="image/png">
  <link rel="icon" href="/favicon.png" type="image/png">

  <link href="/assets/ui/semantic.min.css" rel="stylesheet" />
  <link href="/assets/css/highlight.css" rel="stylesheet">

  <meta name="application-name" content="Kamranicus" />
  <meta name="msapplication-tooltip" content="Kamranicus" />
  <meta name="msapplication-starturl" content="/" />

  <meta property="og:title" content="Kamranicus - Generating an Encryption Certificate for PowerShell DSC in WMF5" /> 
  <meta property="og:type" content="website" />
  <meta property="og:url" content="https://kamranicus.com/posts/2016-04-04-wmf5-powershell-dsc-generating-encryption-certificate" />
  <meta property="og:site_name" content="Kamranicus" />

  <!-- TODO: More social graph meta tags -->
  <script type="application/ld+json">
  {
      "@context": "http://schema.org",
      "@type": "WebSite",
      "name": "Kamranicus",
      "url": "https://kamranicus.com/",
      "sameAs": [
        "http://www.twitter.com/kamranayub"
      ]
  }
  </script>


  <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
  <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
  <!--[if lt IE 9]>
    <script src="/assets/js/html5shiv.js"></script>
    <script src="/assets/js/respond.min.js"></script>
  <![endif]-->
  <script src="/assets/js/picturefill.min.js" async></script>


  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-1203259-13']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>
  

  


</head>

<body>

  <!-- Navigation -->
  <div class="ui container">
    <nav class="ui huge text site menu">
      
      <a class="header item" href="/">Kamranicus</a>
      
      <div class="ui right item">
              <div class="item">
        <a href="/about">About</a>
      </div>
      <div class="item">
        <a href="/posts">Archive</a>
      </div>
      <div class="item">
        <a href="/guides">Guides</a>
      </div>
      <div class="item">
        <a href="/projects">Projects</a>
      </div>
      <div class="item">
        <a href="/speaking">Speaking</a>
      </div>
      <div class="item">
        <a href="/travel">Travel</a>
      </div>

      </div>
    </nav>
  </div>
  <!-- Page Header -->

  <header class="ui vertical masthead segment" id="intro-header">
    <div class="ui container">

    
<div class="ui basic vertical segment">
    <h1 class="ui huge header">
      Generating an Encryption Certificate for PowerShell DSC in WMF5
    </h1>
                
    <div class="ui sub header">        
Published on Tuesday, April 5, 2016<br>    </div>
        <div class="ui basic vertical spaced segment">
                    <a role="button" href="/tags/dsc" class="ui small compact button">DSC</a>
                    <a role="button" href="/tags/security" class="ui small compact button">Security</a>
        </div>     
</div>
    </div>
  </header>

  <!-- Main Content -->
  <div class="ui stackable grid container">
    <div class="content column">
      

<div class="ui huge basic post content segment">
  <p>I'm currently building out a PowerShell DSC pull server cluster at work. If you aren't familiar with DSC, I'll talk more about it in an upcoming post that ties it all together. The long and short of it is that DSC is a way to store configuration as code and automate the configuration of many servers at once.</p>
<p>In the recent Windows Management Framework 5 release, Microsoft has improved its support and feature set for DSC but with a new release comes new surprises. The first surprise you may run into, as we did, was that your old WMF4 way of encrypting MOF files doesn't work. In WMF5, the requirements for the certificate used to secure MOF files is stricter. <a href="https://msdn.microsoft.com/en-us/powershell/dsc/securemof">Taken from MSDN</a>:</p>
<ol>
<li>Key Usage:</li>
</ol>
<ul>
<li>Must contain: 'KeyEncipherment' and 'DataEncipherment'.</li>
<li>Should <em>not</em> contain: 'Digital Signature'.</li>
</ul>
<ol start="2">
<li>Enhanced Key Usage:</li>
</ol>
<ul>
<li>Must contain: Document Encryption (1.3.6.1.4.1.311.80.1).</li>
<li>Should <em>not</em> contain: Client Authentication (1.3.6.1.5.5.7.3.2) and Server Authentication (1.3.6.1.5.5.7.3.1).</li>
</ul>
<p>If you read my <a href="http://kamranicus.com/blog/2016/02/24/azure-key-vault-config-encryption-azure/">previous foray into certificates with Azure Key Vault</a>, you know I'm pretty green when it comes to certificate management and terminology. I really didn't know what this stuff meant--I mean, I understand a certificate has key usages and enhanced key usages, but <strong>how does it get them?</strong> It has to do with the certificate request and the template used to provision your certificate.</p>
<p>It turns out Microsoft recommends obtaining a certificate from Active Directory Certificate Services. That's cool, but I'm just a developer who wants to work on DSC, I don't have an ADCS server to give me certificates during testing--that's a different team altogether and when they're primary guy is out of the office, I'm a bit stuck.</p>
<p><strong>Update (4/13)</strong>: <a href="https://msdn.microsoft.com/en-us/powershell/dsc/securemof">TechNet</a> now has a guide on how to generate certificates for WMF5. I'm leaving the rest of this post as-is for posterity.</p>
<h2 id="redirectfrom-blog20160405wmf5-powershell-dsc-generating-encryption-certificate-disqus_identifier-httpkamranicus.comblog20160405wmf5-powershell-dsc-generating-encryption-certificate">RedirectFrom: blog/2016/04/05/wmf5-powershell-dsc-generating-encryption-certificate/
disqus_identifier: <a href="http://kamranicus.com/blog/2016/04/05/wmf5-powershell-dsc-generating-encryption-certificate/">http://kamranicus.com/blog/2016/04/05/wmf5-powershell-dsc-generating-encryption-certificate/</a></h2>
<p>I thought I could maybe use a self-signed certificate while I wait for a &quot;for real&quot; one later. After searching around for a method to create a certificate with the required KU and EKU specs, I found a lot of answers suggesting using OpenSSL. I've never used OpenSSL before so I thought I'd give it a try and I found it a bit confusing--I think I could have gotten it to work but instead I came across a random PowerShell article (unrelated to anything) using a utility called <code>certreq</code> that could handle providing custom key usages, problem solved!</p>
<p>You just need to create a file to define your certificate settings, <strong>MyCert.inf</strong>:</p>
<pre><code>[Version]
Signature = &quot;$Windows NT$&quot;

[Strings]
szOID_ENHANCED_KEY_USAGE = &quot;2.5.29.37&quot;
szOID_DOCUMENT_ENCRYPTION = &quot;1.3.6.1.4.1.311.80.1&quot;

[NewRequest]
Subject = &quot;cn=me&#64;example.com&quot;
MachineKeySet = false
KeyLength = 2048
KeySpec = AT_KEYEXCHANGE
HashAlgorithm = Sha1
Exportable = true
RequestType = Cert

KeyUsage = &quot;CERT_KEY_ENCIPHERMENT_KEY_USAGE | CERT_DATA_ENCIPHERMENT_KEY_USAGE&quot;
ValidityPeriod = &quot;Years&quot;
ValidityPeriodUnits = &quot;1000&quot;

[Extensions]
%szOID_ENHANCED_KEY_USAGE% = &quot;{text}%szOID_DOCUMENT_ENCRYPTION%&quot;
</code></pre>
<p>Just change the <code>Subject</code> line to whatever you need in your case.</p>
<p>Then execute <code>certreq</code> using the input file:</p>
<pre><code>certreq -new MyCert.inf MyCert.cer
</code></pre>
<p>Certreq should be available if you have Makecert--if you aren't finding it in the default command prompt, try using the Visual Studio Command Prompt. Once you execute the command it will generate a public key file and install the private/public key pair into your <code>CurrentUser</code> personal certificate store:</p>
<pre><code>PS&gt; dir Cert:\CurrentUser\My
</code></pre>
<p>From there, you can export the private/public keys and install it on your DSC nodes.</p>
<p><img src="https://cloud.githubusercontent.com/assets/563819/14269791/dac55acc-fa9c-11e5-8352-55881c3150ed.png" class="img-fluid" alt="Example screenshot" /></p>
<p>Until you get a signed certificate from your CA, this should work. Hope that helps!</p>

</div>

<div class="ui horizontal divider">
  About Kamran
</div>

<div class="ui items">
  <div class="item">
    <div class="ui small circular image">
      <img src="/assets/images/me.jpg" title="Kamran Ayub">
    </div>

    <div class="content">
      <div class="description">
        Hi, I&#x27;m a professional full-stack developer who also loves to write, speak at conferences, work on side projects, contribute to open source, make games, and play them.
      </div>
      <div class="extra">
        <a class="ui circular icon button" href="https://twitter.com/kamranayub" title="Twitter">
  <i class="twitter icon"></i>
</a>
<a class="ui circular icon button" href="https://github.com/kamranayub" title="GitHub">
  <i class="github icon"></i>
</a>
<a class="ui circular icon button" href="https://instagram.com/subkamran" title="Instagram">
  <i class="instagram icon"></i>
</a>
<a class="ui circular icon button" href="https://www.youtube.com/channel/UCq6oaAI3ZH2rGlmC9VqJm1g" title="YouTube">
  <i class="youtube icon"></i>
</a>
<a class="ui circular icon button" href="https://www.linkedin.com/in/subkamran" title="LinkedIn">
  <i class="linkedin icon"></i>
</a>
      </div>
    </div>
  </div>
</div>

<div id="disqus_thread"></div>

<script type="text/javascript">
    var disqus_shortname = 'kamranicus';
    var disqus_identifier = 'http://kamranicus.com/blog/2016/04/05/wmf5-powershell-dsc-generating-encryption-certificate/';
    var disqus_title = 'Generating an Encryption Certificate for PowerShell DSC in WMF5';
    var disqus_url = 'https://kamranicus.com/posts/2016-04-04-wmf5-powershell-dsc-generating-encryption-certificate';

    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
    
    (function () {
        var s = document.createElement('script'); s.async = true;
        s.type = 'text/javascript';
        s.src = '//' + disqus_shortname + '.disqus.com/count.js';
        (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
    }());
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>

      <!-- Disqus -->
<div id="disqus_thread"></div>

<script type="text/javascript">
    var disqus_shortname = 'kamranicus';
    var disqus_identifier = 'http://kamranicus.com/blog/2016/04/05/wmf5-powershell-dsc-generating-encryption-certificate/';
    var disqus_title = 'Generating an Encryption Certificate for PowerShell DSC in WMF5';
    var disqus_url = 'https://kamranicus.com/posts/2016-04-04-wmf5-powershell-dsc-generating-encryption-certificate';

    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
    
    (function () {
        var s = document.createElement('script'); s.async = true;
        s.type = 'text/javascript';
        s.src = '//' + disqus_shortname + '.disqus.com/count.js';
        (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
    }());
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>    </div>
  </div>

  <div class="ui divider"></div>
  
  <!-- Footer -->
  <footer>   
    <div class="ui center aligned container">
  <p class="ui grey sub header">Copyright Â© Kamran Ayub 2017</p>
  
  <div class="ui basic vertical segment">
    <a class="ui circular icon button" href="https://twitter.com/kamranayub" title="Twitter">
  <i class="twitter icon"></i>
</a>
<a class="ui circular icon button" href="https://github.com/kamranayub" title="GitHub">
  <i class="github icon"></i>
</a>
<a class="ui circular icon button" href="https://instagram.com/subkamran" title="Instagram">
  <i class="instagram icon"></i>
</a>
<a class="ui circular icon button" href="https://www.youtube.com/channel/UCq6oaAI3ZH2rGlmC9VqJm1g" title="YouTube">
  <i class="youtube icon"></i>
</a>
<a class="ui circular icon button" href="https://www.linkedin.com/in/subkamran" title="LinkedIn">
  <i class="linkedin icon"></i>
</a>
  </div>

  <p class="ui basic vertical segment">      
    <a href="http://feeds.feedburner.com/Kamranicus" class="ui right labeled icon button">
      Subscribe via RSS or email
      <i class="right rss icon"></i>
    </a>
  </p>  
  <p class="ui tiny basic vertical segment">
    <a href="https://wyam.io">Statically generated by Wyam</a>
  </p>
</div>

  </footer>

  <script src="https://code.jquery.com/jquery-3.1.1.min.js" integrity="sha256-hVVnYaiADRTO2PzUGmuLJr8BLUSjGIZsDYGmIJLv2b8="
    crossorigin="anonymous"></script>
  <script src="/assets/ui/semantic.min.js"></script>
  <script src="/assets/js/highlight.pack.js"></script>

  

  <script>hljs.initHighlightingOnLoad();</script>
</body>
</html>