<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=Edge" />

  <title>Kamranicus | Kamran Ayub - Using Storybook in a Monorepo</title>
  <meta name="description" content="Kamran Ayub" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="author" content="Kamran Ayub">

  <link href="http://feeds.feedburner.com/Kamranicus" rel="alternate" title="Kamranicus (RSS)" type="application/atom+xml">
  <link rel="shortcut icon" href="/favicon.png" type="image/png">
  <link rel="icon" href="/favicon.png" type="image/png">

  <link href="/assets/ui/semantic.min.css" rel="stylesheet" />
  <link href="/assets/css/highlight.css" rel="stylesheet">

  <meta name="monetization" content="$ilp.uphold.com/GkRBn6N6hM9q" />
  
  <meta name="application-name" content="Kamranicus | Kamran Ayub" />
  <meta name="msapplication-tooltip" content="Kamranicus | Kamran Ayub" />
  <meta name="msapplication-starturl" content="/" />

  <meta property="og:title" content="Kamranicus | Kamran Ayub - Using Storybook in a Monorepo" /> 
  <meta property="og:type" content="website" />
  <meta property="og:url" content="https://kamranicus.com/posts/2019-09-12-using-storybook-in-a-monorepo" />
  <meta property="og:site_name" content="Kamranicus" />
  <meta property="twitter:card" content="summary" />
  <meta property="twitter:creator" content="@kamranayub" />

  <!-- TODO: More social graph meta tags -->
  <script type="application/ld+json">
  {
      "@context": "http://schema.org",
      "@type": "WebSite",
      "name": "Kamranicus",
      "url": "https://kamranicus.com/",
      "sameAs": [
        "http://www.twitter.com/kamranayub"
      ]
  }
  </script>


  <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
  <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
  <!--[if lt IE 9]>
    <script src="/assets/js/html5shiv.js"></script>
    <script src="/assets/js/respond.min.js"></script>
  <![endif]-->
  <script src="/assets/js/picturefill.min.js" async></script>

  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-1203259-13']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>
  

  


</head>

<body>

  <!-- Navigation -->
  <div class="ui container">
    <nav class="ui huge text site menu">
      
      <a class="header item" href="/">Kamranicus | Kamran Ayub</a>
      
      <div class="ui right item">
              <div class="item">
        <a href="/about">Contact</a>
      </div>
      <div class="item">
        <a href="/events">Events</a>
      </div>
      <div class="item">
        <a href="/guides">Guides</a>
      </div>
      <div class="item">
        <a href="/projects">Projects</a>
      </div>
      <div class="item">
        <a href="/training">Training</a>
      </div>
      <div class="item">
        <a href="/travel">Travel</a>
      </div>

      </div>
    </nav>
  </div>
  <!-- Page Header -->

  <header class="ui vertical masthead segment  " id="intro-header">
    <div class="ui container">

    
<div class="ui basic vertical segment">
    <h1 class="ui  huge header">
      Using Storybook in a Monorepo
        <div class="ui sub header">Storybook can work across packages in a monorepo, you just need to know how to set it up</div>
    </h1>
                
    <div class="ui  sub header">        
Published on Tuesday, September 17, 2019<br>    </div>
        <div class="ui basic vertical spaced segment">
                    <a role="button" href="/tags/JavaScript" class="ui small compact button">JavaScript</a>
                    <a role="button" href="/tags/React" class="ui small compact button">React</a>
                    <a role="button" href="/tags/Storybook" class="ui small compact button">Storybook</a>
        </div>     
</div>
    </div>
  </header>

  <!-- Main Content -->
  <div class="ui stackable grid container">
    <div class="content column">
      

<div class="ui huge basic post content segment">
  <p>I'm currently working in a small monorepo and we have multiple packages set up for shared components, like this:</p>
<pre><code>packages/
  atoms/
  molecules/
  organisms/
</code></pre>
<p>Each package has React components under a <code>src</code> directory and since each directory <em>is</em> a package, they also contain <code>node_modules</code> (more on why that's important below).</p>
<pre><code>packages/
  atoms/
    node_modules/
    src/
      components/
        Hello.js
        Hello.stories.js
    package.json
  molecules/
  organisms/
</code></pre>
<p>This is different than other posts I've seen that use a root <code>stories/</code> directory -- that is not how we'd like to set up our repo, we'd prefer stories to live right next to the components they describe.</p>
<h2 id="setting-up-storybook">Setting Up Storybook</h2>
<p>You can follow the same steps on the <a href="https://storybook.js.org/docs/guides/guide-react/">getting started page</a> for setting up Storybook in a monorepo.</p>
<p>Once it's done, you should have a new folder at the root:</p>
<pre><code>.storybook/
  config.js
</code></pre>
<p>If not, make sure that gets created. We need to make some changes to <code>config.js</code> to read stories within each package in the monorepo.</p>
<h2 id="configuring-storybook-for-a-monorepo">Configuring Storybook for a Monorepo</h2>
<p>The key issue I ran into that prompted me to write about this is that we need to import stories using the <a href="https://github.com/webpack/docs/wiki/context">Webpack context</a>:</p>
<pre><code class="language-js">require.context('../packages', true, /stories.jsx?$/);
</code></pre>
<p>This prompts Webpack to scan a <code>src</code> directory for paths containing <code>stories.js</code> or <code>stories.jsx</code> anywhere in the string.</p>
<p>Since Webpack <em>statically analyzes</em> this code it means we <strong>cannot</strong> dynamically read the file system and iterate through each package directory (I tried that 😔).</p>
<p>There's another problem. Remember I mentioned each package directory has <code>node_modules</code> and possibly other directories which means that the following paths will match the regular expression:</p>
<pre><code># some node modules (like Storybook itself) use Storybook
./atoms/node_modules/&#64;storybook__react/src/stories/blah.stories.js

# code coverage reports, uses same paths!
./molecules/lcov-report/_html/src/components/Hello.stories.js
</code></pre>
<p>And you can imagine more paths like that can match. Webpack will attempt to import these files into the bundle it generates but these will most likely cause build errors. That isn't what we want! We need to <em>exclude</em> everything but the <code>src</code> directory in a package when matching files.</p>
<p>The solution, as it turns out is fairly straightforward, since we have a convention where each package has components within a <code>src</code> directory, we really just need to match that inner <code>src</code> after the package name, so we can write a regular expression like this:</p>
<pre><code class="language-js">require.context('../packages', true, /^\.\/[^\/]+\/src\/.*stories\.jsx?$/);
</code></pre>
<p>Let's break it down:</p>
<pre><code>^               # match beginning of path
\.\/            # the path will begin with a &quot;./&quot;, like ./atoms
[^\/]+          # get the first path segment (match characters up to first /)
\/src\/         # ensure we match under the `src` directory
.*              # match any character
stories\.jsx?   # match anything with &quot;stories.js(x)&quot; in it
$               # match end of string
</code></pre>
<p>Here's an example using my favorite regex tool <a href="https://regexr.com">RegExr</a> on which paths match and which don't:</p>
<p><img src="https://user-images.githubusercontent.com/563819/65041547-a4e08500-d91c-11e9-895d-7acaf4cc65a1.png" class="img-fluid" alt="regex example" /></p>
<p>Handy!</p>
<h2 id="the-final-config">The Final Config</h2>
<p>Here's our final <code>config.js</code>:</p>
<pre><code class="language-js">import { configure } from '&#64;storybook/react';

function loadStories() {
  const req = require.context('../packages', true, /^\.\/[^\/]+\/src\/.*stories\.jsx?$/);
  req.keys().forEach(filename =&gt; req(filename));
}

configure(loadStories, module);
</code></pre>
<p>I hope this helps someone else and saves them the few hours I spent performing the correct rites to get this to work!</p>

</div>

<h3 class="ui horizontal divider">
  Don't miss any updates!
</h3>

<div class="ui two column mobile tablet computer reversed divided grid">
  <div class="row">
    <div class="column">
      <p class="ui text tiny"><em>No spam and I usually send a newsletter once a quarter with content you won't see on the blog.</em></p>
    </div>
    <div class="column">
      <div class="ui items" id="mc_embed_signup">
        <form action="https://kamranicus.us18.list-manage.com/subscribe/post?u=45a27b0b6fc6f929b90e35338&amp;id=89bb6697c0" method="post" id="mc-embedded-subscribe-form" name="mc-embedded-subscribe-form" class="validate" target="_blank" novalidate>
          <div class="item" id="mc_embed_signup_scroll">
            <div class="content">
              <div class="ui input">
                <input type="email" value="" name="EMAIL" placeholder="Your Email" class="required email" id="mce-EMAIL">
              </div>
              <div id="mce-responses" class="clear" style="margin-top: 1em;">
                <div class="response" id="mce-error-response" style="display:none"></div>
                <div class="response" id="mce-success-response" style="display:none"></div>
              </div>    <!-- real people should not fill this in and expect good things - do not remove this or risk form bot signups-->
              <div style="position: absolute; left: -5000px;" aria-hidden="true"><input type="text" name="b_45a27b0b6fc6f929b90e35338_89bb6697c0" tabindex="-1" value=""></div>
              <div class="clear"><input type="submit" value="Subscribe" name="subscribe" id="mc-embedded-subscribe" class="ui primary button"></div>
            </div>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>

<div class="ui horizontal divider">
  About Kamran
</div>

<div class="ui items">
  <div class="item">
    <div class="ui small circular image">
      <img src="/assets/images/me.jpg" title="Kamran Ayub">
    </div>

    <div class="content">
      <div class="description">
        <p>I&#x27;m a technologist, speaker, and Pluralsight author and I specialize in building full-stack solutions with a focus on modern web technology and cloud native architecture.</p>
        <p><a href="http://bit.ly/KamranOnPluralsight"><img src="/assets/images/pluralsight.png" alt="Kamran's Pluralsight courses" title="Check out my Pluralsight courses!" style="max-width:80%;margin:1em 0;"></a></p>
      </div>
      <div class="extra">
        <a class="ui circular icon button" href="https://twitter.com/kamranayub" title="Twitter">
  <i class="twitter icon"></i>
</a>
<a class="ui circular icon button" href="https://github.com/kamranayub" title="GitHub">
  <i class="github icon"></i>
</a>
<a class="ui circular icon button" href="https://instagram.com/subkamran" title="Instagram">
  <i class="instagram icon"></i>
</a>
<a class="ui circular icon button" href="http://www.youtube.com/c/Kamranicus " title="YouTube">
  <i class="youtube icon"></i>
</a>
<a class="ui circular icon button" href="https://twitch.tv/kamranicus " title="YouTube">
  <i class="twitch icon"></i>
</a>
<a class="ui circular icon button" href="https://www.linkedin.com/in/subkamran" title="LinkedIn">
  <i class="linkedin icon"></i>
</a>
      </div>
    </div>
  </div>
</div>

<div id="disqus_thread"></div>

<script type="text/javascript">
    var disqus_shortname = 'kamranicus';
    var disqus_identifier = '2019-09-12-using-storybook-in-a-monorepo';
    var disqus_title = 'Using Storybook in a Monorepo';
    var disqus_url = 'https://kamranicus.com/posts/2019-09-12-using-storybook-in-a-monorepo';

    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
    
    (function () {
        var s = document.createElement('script'); s.async = true;
        s.type = 'text/javascript';
        s.src = '//' + disqus_shortname + '.disqus.com/count.js';
        (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
    }());
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>

      <!-- Disqus -->
    </div>
  </div>

  <div class="ui divider"></div>
  
  <!-- Footer -->
  <footer>   
    <div class="ui center aligned container">
  <p class="ui grey sub header">Copyright © Kamran Ayub 2020</p>
  
  <div class="ui basic vertical segment">
    <a class="ui circular icon button" href="https://twitter.com/kamranayub" title="Twitter">
  <i class="twitter icon"></i>
</a>
<a class="ui circular icon button" href="https://github.com/kamranayub" title="GitHub">
  <i class="github icon"></i>
</a>
<a class="ui circular icon button" href="https://instagram.com/subkamran" title="Instagram">
  <i class="instagram icon"></i>
</a>
<a class="ui circular icon button" href="http://www.youtube.com/c/Kamranicus " title="YouTube">
  <i class="youtube icon"></i>
</a>
<a class="ui circular icon button" href="https://twitch.tv/kamranicus " title="YouTube">
  <i class="twitch icon"></i>
</a>
<a class="ui circular icon button" href="https://www.linkedin.com/in/subkamran" title="LinkedIn">
  <i class="linkedin icon"></i>
</a>
  </div>

  <p class="ui basic vertical segment">      
    <a href="http://feeds.feedburner.com/Kamranicus" class="ui right labeled icon button">
      Subscribe via RSS or email
      <i class="right rss icon"></i>
    </a>
  </p>  
  <p class="ui tiny basic vertical segment">
    <a href="https://wyam.io">Statically generated by Wyam</a>
  </p>
</div>

  </footer>

  <script src="https://code.jquery.com/jquery-3.1.1.min.js" integrity="sha256-hVVnYaiADRTO2PzUGmuLJr8BLUSjGIZsDYGmIJLv2b8="
    crossorigin="anonymous"></script>
  <script src="/assets/ui/semantic.min.js"></script>
  <script src="/assets/js/highlight.pack.js"></script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<script>
     (adsbygoogle = window.adsbygoogle || []).push({
          google_ad_client: "ca-pub-6930375300621668",
          enable_page_level_ads: true
     });
</script>

  <script>hljs.initHighlightingOnLoad();</script>
</body>
</html>
